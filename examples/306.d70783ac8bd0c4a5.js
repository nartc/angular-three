"use strict";(self.webpackChunksandbox=self.webpackChunksandbox||[]).push([[306],{8405:(Et,Re,z)=>{z.d(Re,{CD:()=>Ue,CI:()=>Ni,DD:()=>M,H5:()=>dn,Xs:()=>$i,YQ:()=>E,bn:()=>ji,gh:()=>pn,rk:()=>ni,xC:()=>An,xs:()=>cn});var o=z(6128),Y="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}";function ne(e,t,n){return e*(t-n)-t}function ie(e,t,n){return Math.min(Math.max((e+t)/(t-n),0),1)}var E={SKIP:9,SET:30,ADD:0,ALPHA:1,AVERAGE:2,COLOR:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,DIVIDE:8,DST:9,EXCLUSION:10,HARD_LIGHT:11,HARD_MIX:12,HUE:13,INVERT:14,INVERT_RGB:15,LIGHTEN:16,LINEAR_BURN:17,LINEAR_DODGE:18,LINEAR_LIGHT:19,LUMINOSITY:20,MULTIPLY:21,NEGATION:22,NORMAL:23,OVERLAY:24,PIN_LIGHT:25,REFLECT:26,SATURATION:27,SCREEN:28,SOFT_LIGHT:29,SRC:30,SUBTRACT:31,VIVID_LIGHT:32},y={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},M={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5},we=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],Ne=class extends o.jyz{constructor(e=new o.Ltg){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new o.xWb(null),texelSize:new o.xWb(new o.Ltg),scale:new o.xWb(1),kernel:new o.xWb(0)},blending:o.jFi,depthWrite:!1,depthTest:!1,fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;\n#include <encodings_fragment>\n}",vertexShader:"uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}"}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernelSize=M.MEDIUM}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.inputBuffer=e}get kernelSequence(){return we[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}getScale(){return this.uniforms.scale.value}setScale(e){this.uniforms.scale.value=e}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(e){this.uniforms.kernel.value=e}setKernel(e){this.kernel=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t,.5*e,.5*t)}setSize(e,t){const n=1/e,i=1/t;this.uniforms.texelSize.value.set(n,i,.5*n,.5*i)}},fe=class extends o.jyz{constructor(){super({name:"CopyMaterial",uniforms:{inputBuffer:new o.xWb(null),opacity:new o.xWb(1)},blending:o.jFi,depthWrite:!1,depthTest:!1,fragmentShader:"#include <common>\n#include <dithering_pars_fragment>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\nuniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;\n#include <encodings_fragment>\n#include <dithering_fragment>\n}",vertexShader:Y}),this.toneMapped=!1}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}getOpacity(e){return this.uniforms.opacity.value}setOpacity(e){this.uniforms.opacity.value=e}},Ke=class extends o.jyz{constructor(){super({name:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new o.xWb(null),normalBuffer:new o.xWb(null),texelSize:new o.xWb(new o.FM8)},blending:o.jFi,depthWrite:!1,depthTest:!1,fragmentShader:"#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\n#ifdef DOWNSAMPLE_NORMALS\nuniform lowp sampler2D normalBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])/4.0;float distances[4];distances[0]=abs(c-samples[0]);distances[1]=abs(c-samples[1]);distances[2]=abs(c-samples[2]);distances[3]=abs(c-samples[3]);float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4];d[0]=readDepth(vUv0);d[1]=readDepth(vUv1);d[2]=readDepth(vUv2);d[3]=readDepth(vUv3);int index=findBestDepth(d);\n#ifdef DOWNSAMPLE_NORMALS\nvec2 uvs[4];uvs[0]=vUv0;uvs[1]=vUv1;uvs[2]=vUv2;uvs[3]=vUv3;vec3 n=texture2D(normalBuffer,uvs[index]).rgb;\n#else\nvec3 n=vec3(0.0);\n#endif\ngl_FragColor=vec4(n,d[index]);}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}"}),this.toneMapped=!1}set depthBuffer(e){this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=o.z81){this.depthBuffer=e,this.depthPacking=t}set normalBuffer(e){this.uniforms.normalBuffer.value=e,null!==e?this.defines.DOWNSAMPLE_NORMALS="1":delete this.defines.DOWNSAMPLE_NORMALS,this.needsUpdate=!0}setNormalBuffer(e){this.normalBuffer=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},$e=class extends o.jyz{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new o.xWb(null),texelSize:new o.xWb(new o.FM8)},blending:o.jFi,depthWrite:!1,depthTest:!1,fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#define WEIGHT_INNER 0.125\n#define WEIGHT_OUTER 0.0555555\nvarying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;\n#include <encodings_fragment>\n}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}"}),this.toneMapped=!1}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},st=class extends o.jyz{constructor(e,t,n,i,r=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:o.UZH.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new o.xWb(null),depthBuffer:new o.xWb(null),resolution:new o.xWb(new o.FM8),texelSize:new o.xWb(new o.FM8),cameraNear:new o.xWb(.3),cameraFar:new o.xWb(1e3),aspect:new o.xWb(1),time:new o.xWb(0)},blending:o.jFi,depthWrite:!1,depthTest:!1,dithering:r}),this.toneMapped=!1,e&&this.setShaderParts(e),t&&this.setDefines(t),n&&this.setUniforms(n),this.adoptCameraSettings(i)}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){this.uniforms.depthBuffer.value=e}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=o.z81){this.depthBuffer=e,this.depthPacking=t}setShaderData(e){this.setShaderParts(e.shaderParts),this.setDefines(e.defines),this.setUniforms(e.uniforms),this.setExtensions(e.extensions)}setShaderParts(e){var t,n,i,r,s;return this.fragmentShader="#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#define packFloatToRGBA(v) packDepthToRGBA(v)\n#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;\n#if THREE_REVISION >= 137\nvec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}\n#endif\nfloat readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNear,cameraFar);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNear,cameraFar);\n#endif\n}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEADvoid main(){FRAGMENT_MAIN_UVvec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGEgl_FragColor=color0;\n#ifdef ENCODE_OUTPUT\n#include <encodings_fragment>\n#endif\n#include <dithering_fragment>\n}".replace(y.FRAGMENT_HEAD,null!=(t=e.get(y.FRAGMENT_HEAD))?t:"").replace(y.FRAGMENT_MAIN_UV,null!=(n=e.get(y.FRAGMENT_MAIN_UV))?n:"").replace(y.FRAGMENT_MAIN_IMAGE,null!=(i=e.get(y.FRAGMENT_MAIN_IMAGE))?i:""),this.vertexShader="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEADvoid main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORTgl_Position=vec4(position.xy,1.0,1.0);}".replace(y.VERTEX_HEAD,null!=(r=e.get(y.VERTEX_HEAD))?r:"").replace(y.VERTEX_MAIN_SUPPORT,null!=(s=e.get(y.VERTEX_MAIN_SUPPORT))?s:""),this.needsUpdate=!0,this}setDefines(e){for(const t of e.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(e){for(const t of e.entries())this.uniforms[t[0]]=t[1];return this}setExtensions(e){this.extensions={};for(const t of e)this.extensions[t]=!0;return this}get encodeOutput(){return void 0!==this.defines.ENCODE_OUTPUT}set encodeOutput(e){this.encodeOutput!==e&&(e?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(e){return this.encodeOutput}setOutputEncodingEnabled(e){this.encodeOutput=e}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setDeltaTime(e){this.uniforms.time.value+=e}adoptCameraSettings(e){e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof o.cPb?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const n=this.uniforms;n.resolution.value.set(e,t),n.texelSize.value.set(1/e,1/t),n.aspect.value=e/t}static get Section(){return y}},Qt=class extends o.jyz{constructor(e=!1,t=null){super({name:"LuminanceMaterial",uniforms:{inputBuffer:new o.xWb(null),threshold:new o.xWb(0),smoothing:new o.xWb(1),range:new o.xWb(null)},blending:o.jFi,depthWrite:!1,depthTest:!1,fragmentShader:"#include <common>\n#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;\n#else\nuniform lowp sampler2D inputBuffer;\n#endif\n#ifdef RANGE\nuniform vec2 range;\n#elif defined(THRESHOLD)\nuniform float threshold;uniform float smoothing;\n#endif\nvarying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=linearToRelativeLuminance(texel.rgb);\n#ifdef RANGE\nfloat low=step(range.x,l);float high=step(l,range.y);l*=low*high;\n#elif defined(THRESHOLD)\nl=smoothstep(threshold,threshold+smoothing,l);\n#endif\n#ifdef COLOR\ngl_FragColor=vec4(texel.rgb*l,l);\n#else\ngl_FragColor=vec4(l);\n#endif\n}",vertexShader:Y}),this.toneMapped=!1,this.colorOutput=e,this.luminanceRange=t}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get threshold(){return this.uniforms.threshold.value}set threshold(e){this.smoothing>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=e}getThreshold(){return this.threshold}setThreshold(e){this.threshold=e}get smoothing(){return this.uniforms.smoothing.value}set smoothing(e){this.threshold>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=e}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(e){this.smoothing=e}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(e){}get colorOutput(){return void 0!==this.defines.COLOR}set colorOutput(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(e){return this.colorOutput}setColorOutputEnabled(e){this.colorOutput=e}get useRange(){return null!==this.luminanceRange}set useRange(e){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(e){null!==e?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=e,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(e){this.luminanceRange=e}},en=class extends o.jyz{constructor(e){super({name:"SSAOMaterial",defines:{SAMPLES_INT:"0",SAMPLES_FLOAT:"0.0",SPIRAL_TURNS:"0.0",RADIUS:"1.0",RADIUS_SQ:"1.0",DISTANCE_SCALING:"1",DEPTH_PACKING:"0"},uniforms:{depthBuffer:new o.xWb(null),normalBuffer:new o.xWb(null),normalDepthBuffer:new o.xWb(null),noiseTexture:new o.xWb(null),inverseProjectionMatrix:new o.xWb(new o.yGw),projectionMatrix:new o.xWb(new o.yGw),texelSize:new o.xWb(new o.FM8),cameraNearFar:new o.xWb(new o.FM8),distanceCutoff:new o.xWb(new o.FM8),proximityCutoff:new o.xWb(new o.FM8),noiseScale:new o.xWb(new o.FM8),minRadiusScale:new o.xWb(.33),intensity:new o.xWb(1),fade:new o.xWb(.01),bias:new o.xWb(0)},blending:o.jFi,depthWrite:!1,depthTest:!1,fragmentShader:"#include <common>\n#include <packing>\n#ifdef NORMAL_DEPTH\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D normalDepthBuffer;\n#else\nuniform mediump sampler2D normalDepthBuffer;\n#endif\n#else\nuniform lowp sampler2D normalBuffer;\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nfloat readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}\n#endif\nuniform lowp sampler2D noiseTexture;uniform mat4 inverseProjectionMatrix;uniform mat4 projectionMatrix;uniform vec2 texelSize;uniform vec2 cameraNearFar;uniform float minRadiusScale;uniform float intensity;uniform float fade;uniform float bias;uniform vec2 distanceCutoff;uniform vec2 proximityCutoff;varying vec2 vUv;varying vec2 vUv2;float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);\n#endif\n}vec3 getViewPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){vec4 clipPosition=vec4(vec3(screenPosition,depth)*2.0-1.0,1.0);float clipW=projectionMatrix[2][3]*viewZ+projectionMatrix[3][3];clipPosition*=clipW;return(inverseProjectionMatrix*clipPosition).xyz;}float getAmbientOcclusion(const in vec3 p,const in vec3 n,const in float depth,const in vec2 uv){\n#ifdef DISTANCE_SCALING\nfloat radiusScale=1.0-smoothstep(0.0,distanceCutoff.y,depth);radiusScale=radiusScale*(1.0-minRadiusScale)+minRadiusScale;float radius=RADIUS*radiusScale;\n#else\nfloat radius=RADIUS;\n#endif\nfloat noise=texture2D(noiseTexture,vUv2).r;float baseAngle=noise*PI2;float invSamples=1.0/SAMPLES_FLOAT;float rings=SPIRAL_TURNS*PI2;float occlusion=0.0;int taps=0;for(int i=0;i<SAMPLES_INT;++i){float alpha=(float(i)+0.5)*invSamples;float angle=alpha*rings+baseAngle;vec2 coord=alpha*radius*vec2(cos(angle),sin(angle))*texelSize+uv;if(coord.s<0.0||coord.s>1.0||coord.t<0.0||coord.t>1.0){continue;}\n#ifdef NORMAL_DEPTH\nfloat sampleDepth=texture2D(normalDepthBuffer,coord).a;\n#else\nfloat sampleDepth=readDepth(coord);\n#endif\nfloat viewZ=getViewZ(sampleDepth);\n#ifdef PERSPECTIVE_CAMERA\nfloat linearSampleDepth=viewZToOrthographicDepth(viewZ,cameraNearFar.x,cameraNearFar.y);\n#else\nfloat linearSampleDepth=sampleDepth;\n#endif\nfloat proximity=abs(depth-linearSampleDepth);if(proximity<proximityCutoff.y){float falloff=1.0-smoothstep(proximityCutoff.x,proximityCutoff.y,proximity);vec3 Q=getViewPosition(coord,sampleDepth,viewZ);vec3 v=Q-p;float vv=dot(v,v);float vn=dot(v,n)-bias;float f=max(RADIUS_SQ-vv,0.0)/RADIUS_SQ;occlusion+=(f*f*f*max(vn/(fade+vv),0.0))*falloff;}++taps;}return occlusion/(4.0*max(float(taps),1.0));}void main(){\n#ifdef NORMAL_DEPTH\nvec4 normalDepth=texture2D(normalDepthBuffer,vUv);\n#else\nvec4 normalDepth=vec4(texture2D(normalBuffer,vUv).rgb,readDepth(vUv));\n#endif\nfloat ao=1.0;float depth=normalDepth.a;float viewZ=getViewZ(depth);\n#ifdef PERSPECTIVE_CAMERA\nfloat linearDepth=viewZToOrthographicDepth(viewZ,cameraNearFar.x,cameraNearFar.y);\n#else\nfloat linearDepth=depth;\n#endif\nif(linearDepth<distanceCutoff.y){vec3 viewPosition=getViewPosition(vUv,depth,viewZ);vec3 viewNormal=unpackRGBToNormal(normalDepth.rgb);ao-=getAmbientOcclusion(viewPosition,viewNormal,linearDepth,vUv);float d=smoothstep(distanceCutoff.x,distanceCutoff.y,linearDepth);ao=mix(ao,1.0,d);ao=clamp(pow(ao,abs(intensity)),0.0,1.0);}gl_FragColor.r=ao;}",vertexShader:"uniform vec2 noiseScale;varying vec2 vUv;varying vec2 vUv2;void main(){vUv=position.xy*0.5+0.5;vUv2=vUv*noiseScale;gl_Position=vec4(position.xy,1.0,1.0);}"}),this.toneMapped=!1,this.adoptCameraSettings(e),this.resolution=new o.FM8,this.r=1}get near(){return this.uniforms.cameraNearFar.value.x}get far(){return this.uniforms.cameraNearFar.value.y}set normalDepthBuffer(e){this.uniforms.normalDepthBuffer.value=e,null!==e?this.defines.NORMAL_DEPTH="1":delete this.defines.NORMAL_DEPTH,this.needsUpdate=!0}setNormalDepthBuffer(e){this.normalDepthBuffer=e}set normalBuffer(e){this.uniforms.normalBuffer.value=e}setNormalBuffer(e){this.uniforms.normalBuffer.value=e}set depthBuffer(e){this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=o.z81){this.depthBuffer=e,this.depthPacking=t}set noiseTexture(e){this.uniforms.noiseTexture.value=e}setNoiseTexture(e){this.uniforms.noiseTexture.value=e}get samples(){return Number(this.defines.SAMPLES_INT)}set samples(e){this.defines.SAMPLES_INT=e.toFixed(0),this.defines.SAMPLES_FLOAT=e.toFixed(1),this.needsUpdate=!0}getSamples(){return this.samples}setSamples(e){this.samples=e}get rings(){return Number(this.defines.SPIRAL_TURNS)}set rings(e){this.defines.SPIRAL_TURNS=e.toFixed(1),this.needsUpdate=!0}getRings(){return this.rings}setRings(e){this.rings=e}get intensity(){return this.uniforms.intensity.value}set intensity(e){this.uniforms.intensity.value=e}getIntensity(){return this.uniforms.intensity.value}setIntensity(e){this.uniforms.intensity.value=e}get fade(){return this.uniforms.fade.value}set fade(e){this.uniforms.fade.value=e}getFade(){return this.uniforms.fade.value}setFade(e){this.uniforms.fade.value=e}get bias(){return this.uniforms.bias.value}set bias(e){this.uniforms.bias.value=e}getBias(){return this.uniforms.bias.value}setBias(e){this.uniforms.bias.value=e}get minRadiusScale(){return this.uniforms.minRadiusScale.value}set minRadiusScale(e){this.uniforms.minRadiusScale.value=e}getMinRadiusScale(){return this.uniforms.minRadiusScale.value}setMinRadiusScale(e){this.uniforms.minRadiusScale.value=e}updateRadius(){const e=this.r*this.resolution.height;this.defines.RADIUS=e.toFixed(11),this.defines.RADIUS_SQ=(e*e).toFixed(11),this.needsUpdate=!0}get radius(){return this.r}set radius(e){this.r=Math.min(Math.max(e,1e-6),1),this.updateRadius()}getRadius(){return this.radius}setRadius(e){this.radius=e}get distanceScaling(){return void 0!==this.defines.DISTANCE_SCALING}set distanceScaling(e){this.isDistanceScalingEnabled()!==e&&(e?this.defines.DISTANCE_SCALING="1":delete this.defines.DISTANCE_SCALING,this.needsUpdate=!0)}isDistanceScalingEnabled(){return this.distanceScaling}setDistanceScalingEnabled(e){this.distanceScaling=e}get distanceThreshold(){return this.uniforms.distanceCutoff.value.x}set distanceThreshold(e){this.uniforms.distanceCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+this.distanceFalloff,0),1))}get worldDistanceThreshold(){return-ne(this.distanceThreshold,this.near,this.far)}set worldDistanceThreshold(e){this.distanceThreshold=ie(-e,this.near,this.far)}get distanceFalloff(){return this.uniforms.distanceCutoff.value.y-this.distanceThreshold}set distanceFalloff(e){this.uniforms.distanceCutoff.value.y=Math.min(Math.max(this.distanceThreshold+e,0),1)}get worldDistanceFalloff(){return-ne(this.distanceFalloff,this.near,this.far)}set worldDistanceFalloff(e){this.distanceFalloff=ie(-e,this.near,this.far)}setDistanceCutoff(e,t){this.uniforms.distanceCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}get proximityThreshold(){return this.uniforms.proximityCutoff.value.x}set proximityThreshold(e){this.uniforms.proximityCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+this.proximityFalloff,0),1))}get worldProximityThreshold(){return-ne(this.proximityThreshold,this.near,this.far)}set worldProximityThreshold(e){this.proximityThreshold=ie(-e,this.near,this.far)}get proximityFalloff(){return this.uniforms.proximityCutoff.value.y-this.proximityThreshold}set proximityFalloff(e){this.uniforms.proximityCutoff.value.y=Math.min(Math.max(this.proximityThreshold+e,0),1)}get worldProximityFalloff(){return-ne(this.proximityFalloff,this.near,this.far)}set worldProximityFalloff(e){this.proximityFalloff=ie(-e,this.near,this.far)}setProximityCutoff(e,t){this.uniforms.proximityCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}adoptCameraSettings(e){e&&(this.uniforms.cameraNearFar.value.set(e.near,e.far),this.uniforms.projectionMatrix.value.copy(e.projectionMatrix),this.uniforms.inverseProjectionMatrix.value.copy(e.projectionMatrix).invert(),e instanceof o.cPb?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const n=this.uniforms,i=n.noiseTexture.value;null!==i&&n.noiseScale.value.set(e/i.image.width,t/i.image.height),n.texelSize.value.set(1/e,1/t),this.resolution.set(e,t),this.updateRadius()}},rn=class extends o.jyz{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new o.xWb(null),supportBuffer:new o.xWb(null),texelSize:new o.xWb(new o.FM8),radius:new o.xWb(.85)},blending:o.jFi,depthWrite:!1,depthTest:!1,fragmentShader:"#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;\n#else\nuniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;\n#endif\nuniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);\n#include <encodings_fragment>\n}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}"}),this.toneMapped=!1}set inputBuffer(e){this.uniforms.inputBuffer.value=e}set supportBuffer(e){this.uniforms.supportBuffer.value=e}get radius(){return this.uniforms.radius.value}set radius(e){this.uniforms.radius.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},sn=new o.V1s,de=null,K=class{constructor(e="Pass",t=new o.xsS,n=sn){this.name=e,this.renderer=null,this.scene=t,this.camera=n,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(e){if(this.rtt===e){const t=this.fullscreenMaterial;null!==t&&(t.needsUpdate=!0),this.rtt=!e}}setRenderer(e){this.renderer=e}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}get fullscreenMaterial(){return null!==this.screen?this.screen.material:null}set fullscreenMaterial(e){let t=this.screen;null!==t?t.material=e:(t=new o.Kj0(function an(){if(null===de){const e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]);void 0!==(de=new o.u9r).setAttribute?(de.setAttribute("position",new o.TlE(e,3)),de.setAttribute("uv",new o.TlE(t,2))):(de.addAttribute("position",new o.TlE(e,3)),de.addAttribute("uv",new o.TlE(t,2)))}return de}(),e),t.frustumCulled=!1,null===this.scene&&(this.scene=new o.xsS),this.scene.add(t),this.screen=t)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(e){this.fullscreenMaterial=e}getDepthTexture(){return null}setDepthTexture(e,t=o.z81){}render(e,t,n,i,r){throw new Error("Render method not implemented!")}setSize(e,t){}initialize(e,t,n){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof o.dd2||t instanceof o.F5T||t instanceof o.xEZ||t instanceof K)&&this[e].dispose()}}},Dt=class extends K{constructor(e,t=!0){super("CopyPass"),this.fullscreenMaterial=new fe,this.needsSwap=!1,this.renderTarget=e,void 0===e&&(this.renderTarget=new o.dd2(1,1,{minFilter:o.wem,magFilter:o.wem,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=t}get resize(){return this.autoResize}set resize(e){this.autoResize=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(e){this.autoResize=e}render(e,t,n,i,r){this.fullscreenMaterial.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){this.autoResize&&this.renderTarget.setSize(e,t)}initialize(e,t,n){void 0!==n&&(this.renderTarget.texture.type=n,n!==o.ywz?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":e.outputEncoding===o.knz&&(this.renderTarget.texture.encoding=o.knz))}},ln=class extends K{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(e,t,n,i,r){const s=e.state.buffers.stencil;s.setLocked(!1),s.setTest(!1)}},lt=new o.Ilk,Te=class extends K{constructor(e=!0,t=!0,n=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=e,this.depth=t,this.stencil=n,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(e,t,n){this.color=e,this.depth=t,this.stencil=n}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(e){this.overrideClearColor=e}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(e){this.overrideClearAlpha=e}render(e,t,n,i,r){const s=this.overrideClearColor,a=this.overrideClearAlpha,l=e.getClearAlpha(),c=null!==s,u=a>=0;c?(lt.copy(e.getClearColor(lt)),e.setClearColor(s,u?a:l)):u&&e.setClearAlpha(a),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),c?e.setClearColor(lt,l):u&&e.setClearAlpha(l)}},I=class extends o.pBf{constructor(e,t=-1,n=-1,i=1){super(),this.resizable=e,this.baseSize=new o.FM8(1,1),this.preferredSize=new o.FM8(t,n),this.target=this.preferredSize,this.s=i,this.effectiveSize=new o.FM8,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const e=this.baseSize,t=this.preferredSize,n=this.effectiveSize,i=this.scale;n.width=-1!==t.width?t.width:-1!==t.height?Math.round(t.height*(e.width/Math.max(e.height,1))):Math.round(e.width*i),n.height=-1!==t.height?t.height:-1!==t.width?Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1)):Math.round(e.height*i)}get width(){return this.effectiveSize.width}set width(e){this.preferredWidth=e}get height(){return this.effectiveSize.height}set height(e){this.preferredHeight=e}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(e){this.s!==e&&(this.s=e,this.preferredSize.setScalar(-1),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(e){this.scale=e}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(e){this.baseWidth=e}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(e){this.baseHeight=e}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(e){this.preferredWidth=e}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(e){this.preferredHeight=e}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(e){this.s=e.scale,this.baseSize.set(e.getBaseWidth(),e.getBaseHeight()),this.preferredSize.set(e.getPreferredWidth(),e.getPreferredHeight()),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return-1}},ct=!1,xt=class{constructor(e=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(e),this.meshCount=0,this.replaceMaterial=t=>{if(t.isMesh){let n;if(t.material.flatShading)switch(t.material.side){case o.ehD:n=this.materialsFlatShadedDoubleSide;break;case o._Li:n=this.materialsFlatShadedBackSide;break;default:n=this.materialsFlatShaded}else switch(t.material.side){case o.ehD:n=this.materialsDoubleSide;break;case o._Li:n=this.materialsBackSide;break;default:n=this.materials}this.originalMaterials.set(t,t.material),t.material=t.isSkinnedMesh?n[2]:t.isInstancedMesh?n[1]:n[0],++this.meshCount}}}setMaterial(e){if(this.disposeMaterials(),this.material=e,null!==e){const t=this.materials=[e.clone(),e.clone(),e.clone()];for(const n of t)n.uniforms=Object.assign({},e.uniforms),n.side=o.Wl3;t[2].skinning=!0,this.materialsBackSide=t.map(n=>{const i=n.clone();return i.uniforms=Object.assign({},e.uniforms),i.side=o._Li,i}),this.materialsDoubleSide=t.map(n=>{const i=n.clone();return i.uniforms=Object.assign({},e.uniforms),i.side=o.ehD,i}),this.materialsFlatShaded=t.map(n=>{const i=n.clone();return i.uniforms=Object.assign({},e.uniforms),i.flatShading=!0,i}),this.materialsFlatShadedBackSide=t.map(n=>{const i=n.clone();return i.uniforms=Object.assign({},e.uniforms),i.flatShading=!0,i.side=o._Li,i}),this.materialsFlatShadedDoubleSide=t.map(n=>{const i=n.clone();return i.uniforms=Object.assign({},e.uniforms),i.flatShading=!0,i.side=o.ehD,i})}}render(e,t,n){const i=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,ct){const r=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),e.render(t,n);for(const s of r)s[0].material=s[1];this.meshCount!==r.size&&r.clear()}else{const r=t.overrideMaterial;t.overrideMaterial=this.material,e.render(t,n),t.overrideMaterial=r}e.shadowMap.enabled=i}disposeMaterials(){if(null!==this.material){const e=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const t of e)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return ct}static set workaroundEnabled(e){ct=e}},Ue=class extends K{constructor(e,t,n=null){super("RenderPass",e,t),this.needsSwap=!1,this.clearPass=new Te,this.overrideMaterialManager=null===n?null:new xt(n),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}get renderToScreen(){return super.renderToScreen}set renderToScreen(e){super.renderToScreen=e,this.clearPass.renderToScreen=e}get overrideMaterial(){const e=this.overrideMaterialManager;return null!==e?e.material:null}set overrideMaterial(e){const t=this.overrideMaterialManager;null!==e?null!==t?t.setMaterial(e):this.overrideMaterialManager=new xt(e):null!==t&&(t.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(e){this.overrideMaterial=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getSelection(){return this.selection}setSelection(e){this.selection=e}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(e){this.ignoreBackground=e}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(e){this.skipShadowMapUpdate=e}getClearPass(){return this.clearPass}render(e,t,n,i,r){const s=this.scene,a=this.camera,l=this.selection,c=a.layers.mask,u=s.background,d=e.shadowMap.autoUpdate,g=this.renderToScreen?null:t;null!==l&&a.layers.set(l.getLayer()),this.skipShadowMapUpdate&&(e.shadowMap.autoUpdate=!1),(this.ignoreBackground||null!==this.clearPass.overrideClearColor)&&(s.background=null),this.clearPass.enabled&&this.clearPass.render(e,t),e.setRenderTarget(g),null!==this.overrideMaterialManager?this.overrideMaterialManager.render(e,s,a):e.render(s,a),a.layers.mask=c,s.background=u,e.shadowMap.autoUpdate=d}},cn=class extends K{constructor({normalBuffer:e=null,resolutionScale:t=.5,width:n=I.AUTO_SIZE,height:i=I.AUTO_SIZE,resolutionX:r=n,resolutionY:s=i}={}){super("DepthDownsamplingPass");const a=new Ke;a.normalBuffer=e,this.fullscreenMaterial=a,this.needsDepthTexture=!0,this.needsSwap=!1,this.renderTarget=new o.dd2(1,1,{minFilter:o.TyD,magFilter:o.TyD,depthBuffer:!1,type:o.VzW}),this.renderTarget.texture.name="DepthDownsamplingPass.Target",this.renderTarget.texture.generateMipmaps=!1;const l=this.resolution=new I(this,r,s,t);l.addEventListener("change",c=>this.setSize(l.baseWidth,l.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}setDepthTexture(e,t=o.z81){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t}render(e,t,n,i,r){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){this.fullscreenMaterial.setSize(e,t);const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height)}initialize(e,t,n){if(!e.capabilities.isWebGL2)throw new Error("The DepthDownsamplingPass requires WebGL 2")}};function Ct(e,t,n){for(const i of t){const r="$1"+e+i.charAt(0).toUpperCase()+i.slice(1),s=new RegExp("([^\\.])(\\b"+i+"\\b)","g");for(const a of n.entries())null!==a[1]&&n.set(a[0],a[1].replace(s,r))}}function fn(e,t,n){var i,r,s,a,l;let c=t.getFragmentShader(),u=t.getVertexShader();const d=void 0!==c&&/mainImage/.test(c),g=void 0!==c&&/mainUv/.test(c);if(n.attributes|=t.getAttributes(),void 0===c)throw new Error(`Missing fragment shader (${t.name})`);if(g&&0!=(2&n.attributes))throw new Error(`Effects that transform UVs are incompatible with convolution effects (${t.name})`);if(!d&&!g)throw new Error(`Could not find mainImage or mainUv function (${t.name})`);{const p=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,v=n.shaderParts;let x=null!=(i=v.get(y.FRAGMENT_HEAD))?i:"",C=null!=(r=v.get(y.FRAGMENT_MAIN_UV))?r:"",T=null!=(s=v.get(y.FRAGMENT_MAIN_IMAGE))?s:"",b=null!=(a=v.get(y.VERTEX_HEAD))?a:"",U=null!=(l=v.get(y.VERTEX_MAIN_SUPPORT))?l:"";const F=new Set,H=new Set;if(g&&(C+=`\t${e}MainUv(UV);\n`,n.uvTransformation=!0),null!==u&&/mainSupport/.test(u)){const k=/mainSupport *\([\w\s]*?uv\s*?\)/.test(u);U+=`\t${e}MainSupport(`,U+=k?"vUv);\n":");\n";for(const S of u.matchAll(/(?:varying\s+\w+\s+(\w*))/g))n.varyings.add(S[1]),F.add(S[1]),H.add(S[1]);for(const S of u.matchAll(p))H.add(S[1])}for(const k of c.matchAll(p))H.add(k[1]);for(const k of t.defines.keys())H.add(k.replace(/\([\w\s,]*\)/g,""));for(const k of t.uniforms.keys())H.add(k);H.delete("while"),H.delete("for"),H.delete("if"),t.uniforms.forEach((k,S)=>n.uniforms.set(e+S.charAt(0).toUpperCase()+S.slice(1),k)),t.defines.forEach((k,S)=>n.defines.set(e+S.charAt(0).toUpperCase()+S.slice(1),k));const J=new Map([["fragment",c],["vertex",u]]);Ct(e,H,n.defines),Ct(e,H,J),c=J.get("fragment"),u=J.get("vertex");const $=t.blendMode;if(n.blendModes.set($.blendFunction,$),d){null!==t.inputColorSpace&&t.inputColorSpace!==n.colorSpace&&(T+=t.inputColorSpace===o.knz?"color0 = LinearTosRGB(color0);\n\t":"color0 = sRGBToLinear(color0);\n\t"),null!==t.outputColorSpace?n.colorSpace=t.outputColorSpace:null!==t.inputColorSpace&&(n.colorSpace=t.inputColorSpace);const k=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;T+=`${e}MainImage(color0, UV, `,0!=(1&n.attributes)&&k.test(c)&&(T+="depth, ",n.readDepth=!0),T+="color1);\n\t";const S=e+"BlendOpacity";n.uniforms.set(S,$.opacity),T+=`color0 = blend${$.blendFunction}(color0, color1, ${S});\n\n\t`,x+=`uniform float ${S};\n\n`}if(x+=c+"\n",null!==u&&(b+=u+"\n"),v.set(y.FRAGMENT_HEAD,x),v.set(y.FRAGMENT_MAIN_UV,C),v.set(y.FRAGMENT_MAIN_IMAGE,T),v.set(y.VERTEX_HEAD,b),v.set(y.VERTEX_MAIN_SUPPORT,U),null!==t.extensions)for(const k of t.extensions)n.extensions.add(k)}}new Float32Array([255/256/256**3,255/256/65536,255/256/256,255/256]);var dn=class extends K{constructor(e,...t){super("EffectPass"),this.fullscreenMaterial=new st(null,null,null,e),this.listener=n=>this.handleEvent(n),this.effects=[],this.setEffects(t),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(e){this.fullscreenMaterial.encodeOutput=e}get dithering(){return this.fullscreenMaterial.dithering}set dithering(e){const t=this.fullscreenMaterial;t.dithering=e,t.needsUpdate=!0}setEffects(e){for(const t of this.effects)t.removeEventListener("change",this.listener);this.effects=e.sort((t,n)=>n.attributes-t.attributes);for(const t of this.effects)t.addEventListener("change",this.listener)}updateMaterial(){const e=new En;let t=0;for(const a of this.effects)if(a.blendMode.blendFunction===E.DST)e.attributes|=1&a.getAttributes();else{if(0!=(e.attributes&a.getAttributes()&2))throw new Error(`Convolution effects cannot be merged (${a.name})`);fn("e"+t++,a,e)}let n=e.shaderParts.get(y.FRAGMENT_HEAD),i=e.shaderParts.get(y.FRAGMENT_MAIN_IMAGE),r=e.shaderParts.get(y.FRAGMENT_MAIN_UV);const s=/\bblend\b/g;for(const a of e.blendModes.values())n+=a.getShaderCode().replace(s,`blend${a.blendFunction}`)+"\n";0!=(1&e.attributes)?(e.readDepth&&(i="float depth = readDepth(UV);\n\n\t"+i),this.needsDepthTexture=null===this.getDepthTexture()):this.needsDepthTexture=!1,e.colorSpace===o.knz&&(i+="color0 = sRGBToLinear(color0);\n\t"),e.uvTransformation?(r="vec2 transformedUv = vUv;\n"+r,e.defines.set("UV","transformedUv")):e.defines.set("UV","vUv"),e.shaderParts.set(y.FRAGMENT_HEAD,n),e.shaderParts.set(y.FRAGMENT_MAIN_IMAGE,i),e.shaderParts.set(y.FRAGMENT_MAIN_UV,r),e.shaderParts.forEach((a,l,c)=>c.set(l,a?.trim().replace(/^#/,"\n#"))),this.skipRendering=0===t,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(e)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(e,t=o.z81){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t;for(const n of this.effects)n.setDepthTexture(e,t)}render(e,t,n,i,r){for(const s of this.effects)s.update(e,t,i);if(!this.skipRendering||this.renderToScreen){const s=this.fullscreenMaterial;s.inputBuffer=t.texture,s.time+=i,e.setRenderTarget(this.renderToScreen?null:n),e.render(this.scene,this.camera)}}setSize(e,t){this.fullscreenMaterial.setSize(e,t);for(const n of this.effects)n.setSize(e,t)}initialize(e,t,n){this.renderer=e;for(const i of this.effects)i.initialize(e,t,n);this.updateMaterial(),void 0!==n&&n!==o.ywz&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const e of this.effects)e.removeEventListener("change",this.listener),e.dispose()}handleEvent(e){"change"===e.type&&this.recompile()}},_e=class extends K{constructor({kernelSize:e=M.MEDIUM,resolutionScale:t=.5,width:n=I.AUTO_SIZE,height:i=I.AUTO_SIZE,resolutionX:r=n,resolutionY:s=i}={}){super("KawaseBlurPass"),this.renderTargetA=new o.dd2(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const a=this.resolution=new I(this,r,s,t);a.addEventListener("change",l=>this.setSize(a.baseWidth,a.baseHeight)),this.blurMaterial=new Ne,this.copyMaterial=new fe}getResolution(){return this.resolution}get dithering(){return this.copyMaterial.dithering}set dithering(e){this.copyMaterial.dithering=e}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(e){this.blurMaterial.kernelSize=e}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get scale(){return this.blurMaterial.scale}set scale(e){this.blurMaterial.scale=e}getScale(){return this.blurMaterial.scale}setScale(e){this.blurMaterial.scale=e}getKernelSize(){return this.kernelSize}setKernelSize(e){this.kernelSize=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,n,i,r){const s=this.scene,a=this.camera,l=this.renderTargetA,c=this.renderTargetB,u=this.blurMaterial,d=u.kernelSequence;let g=t;this.fullscreenMaterial=u;for(let p=0,v=d.length;p<v;++p){const x=0==(1&p)?l:c;u.kernel=d[p],u.inputBuffer=g.texture,e.setRenderTarget(x),e.render(s,a),g=x}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=g.texture,e.setRenderTarget(this.renderToScreen?null:n),e.render(s,a)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t);const i=n.width,r=n.height;this.renderTargetA.setSize(i,r),this.renderTargetB.setSize(i,r),this.blurMaterial.setSize(e,t)}initialize(e,t,n){void 0!==n&&(this.renderTargetA.texture.type=n,this.renderTargetB.texture.type=n,n!==o.ywz?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):e.outputEncoding===o.knz&&(this.renderTargetA.texture.encoding=o.knz,this.renderTargetB.texture.encoding=o.knz))}static get AUTO_SIZE(){return I.AUTO_SIZE}},Tt=class extends K{constructor({renderTarget:e,luminanceRange:t,colorOutput:n,resolutionScale:i=1,width:r=I.AUTO_SIZE,height:s=I.AUTO_SIZE,resolutionX:a=r,resolutionY:l=s}={}){super("LuminancePass"),this.fullscreenMaterial=new Qt(n,t),this.needsSwap=!1,this.renderTarget=e,void 0===this.renderTarget&&(this.renderTarget=new o.dd2(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const c=this.resolution=new I(this,a,l,i);c.addEventListener("change",u=>this.setSize(c.baseWidth,c.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(e,t,n,i,r){this.fullscreenMaterial.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height)}initialize(e,t,n){void 0!==n&&n!==o.ywz&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},hn=class extends K{constructor(e,t){super("MaskPass",e,t),this.needsSwap=!1,this.clearPass=new Te(!1,!1,!0),this.inverse=!1}get inverted(){return this.inverse}set inverted(e){this.inverse=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(e){this.inverted=e}render(e,t,n,i,r){const s=e.getContext(),a=e.state.buffers,l=this.scene,c=this.camera,u=this.clearPass,d=this.inverted?0:1,g=1-d;a.color.setMask(!1),a.depth.setMask(!1),a.color.setLocked(!0),a.depth.setLocked(!0),a.stencil.setTest(!0),a.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),a.stencil.setFunc(s.ALWAYS,d,4294967295),a.stencil.setClear(g),a.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?u.render(e,null):(u.render(e,t),u.render(e,n))),this.renderToScreen?(e.setRenderTarget(null),e.render(l,c)):(e.setRenderTarget(t),e.render(l,c),e.setRenderTarget(n),e.render(l,c)),a.color.setLocked(!1),a.depth.setLocked(!1),a.stencil.setLocked(!1),a.stencil.setFunc(s.EQUAL,1,4294967295),a.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),a.stencil.setLocked(!0)}},gn=class extends K{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new o.dd2(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new $e,this.upsamplingMaterial=new rn,this.resolution=new o.FM8}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(e){if(this.levels!==e){const t=this.renderTarget;this.dispose();for(let n=0;n<e;++n){const i=t.clone();i.texture.name="Downsampling.Mipmap"+n,this.downsamplingMipmaps.push(i)}this.upsamplingMipmaps.push(t);for(let n=1,i=e-1;n<i;++n){const r=t.clone();r.texture.name="Upsampling.Mipmap"+n,this.upsamplingMipmaps.push(r)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(e){this.upsamplingMaterial.radius=e}render(e,t,n,i,r){const{scene:s,camera:a}=this,{downsamplingMaterial:l,upsamplingMaterial:c}=this,{downsamplingMipmaps:u,upsamplingMipmaps:d}=this;let g=t;this.fullscreenMaterial=l;for(let p=0,v=u.length;p<v;++p){const x=u[p];l.setSize(g.width,g.height),l.inputBuffer=g.texture,e.setRenderTarget(x),e.render(s,a),g=x}this.fullscreenMaterial=c;for(let p=d.length-1;p>=0;--p){const v=d[p];c.setSize(g.width,g.height),c.inputBuffer=g.texture,c.supportBuffer=u[p].texture,e.setRenderTarget(v),e.render(s,a),g=v}}setSize(e,t){const n=this.resolution;n.set(e,t);let i=n.width,r=n.height;for(let s=0,a=this.downsamplingMipmaps.length;s<a;++s)i=Math.round(.5*i),r=Math.round(.5*r),this.downsamplingMipmaps[s].setSize(i,r),s<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[s].setSize(i,r)}initialize(e,t,n){if(void 0!==n){const i=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const r of i)r.texture.type=n;if(n!==o.ywz)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(e.outputEncoding===o.knz)for(const r of i)r.texture.encoding=o.knz}}dispose(){super.dispose();for(const e of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))e.dispose();this.downsamplingMipmaps=[],this.upsamplingMipmaps=[]}},pn=class extends K{constructor(e,t,{renderTarget:n,resolutionScale:i=1,width:r=I.AUTO_SIZE,height:s=I.AUTO_SIZE,resolutionX:a=r,resolutionY:l=s}={}){super("NormalPass"),this.needsSwap=!1,this.renderPass=new Ue(e,t,new o.RSm);const c=this.renderPass;c.setBackgroundDisabled(!0),c.setShadowMapDisabled(!0);const u=c.getClearPass();u.setOverrideClearColor(new o.Ilk(7829503)),u.setOverrideClearAlpha(1),this.renderTarget=n,void 0===this.renderTarget&&(this.renderTarget=new o.dd2(1,1,{minFilter:o.TyD,magFilter:o.TyD}),this.renderTarget.texture.name="NormalPass.Target");const d=this.resolution=new I(this,a,l,i);d.addEventListener("change",g=>this.setSize(d.baseWidth,d.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,n,i,r){const s=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,s,s)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height)}},q=class extends K{constructor(e,t="inputBuffer"){super("ShaderPass"),this.fullscreenMaterial=e,this.input=t}setInput(e){}render(e,t,n,i,r){const s=this.fullscreenMaterial.uniforms;null!==t&&void 0!==s&&void 0!==s[this.input]&&(s[this.input].value=t.texture),e.setRenderTarget(this.renderToScreen?null:n),e.render(this.scene,this.camera)}initialize(e,t,n){void 0!==n&&n!==o.ywz&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},An=class{constructor(e=null,{depthBuffer:t=!0,stencilBuffer:n=!1,multisampling:i=0,frameBufferType:r}={}){this.renderer=null,this.inputBuffer=this.createBuffer(t,n,r,i),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new Dt,this.depthTexture=null,this.passes=[],this.timer=new class{constructor(){this.previousTime=0,this.currentTime=0,this.delta=0,this.fixedDelta=1e3/60,this.elapsed=0,this.timescale=1,this.fixedDeltaEnabled=!1,this.autoReset=!1}setFixedDeltaEnabled(e){return this.fixedDeltaEnabled=e,this}isAutoResetEnabled(e){return this.autoReset}setAutoResetEnabled(e){return typeof document<"u"&&void 0!==document.hidden&&(e?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this.autoReset=e),this}getDelta(){return.001*this.delta}getFixedDelta(){return.001*this.fixedDelta}setFixedDelta(e){return this.fixedDelta=1e3*e,this}getElapsed(){return.001*this.elapsed}getTimescale(){return this.timescale}setTimescale(e){return this.timescale=e,this}update(e){return this.fixedDeltaEnabled?this.delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=void 0!==e?e:performance.now(),this.delta=this.currentTime-this.previousTime),this.delta*=this.timescale,this.elapsed+=this.delta,this}reset(){return this.delta=0,this.elapsed=0,this.currentTime=performance.now(),this}handleEvent(e){document.hidden||(this.currentTime=performance.now())}dispose(){this.setAutoResetEnabled(!1)}},this.autoRenderToScreen=!0,this.setRenderer(e)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(e){const t=this.inputBuffer,n=this.multisampling;n>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e,this.inputBuffer.dispose(),this.outputBuffer.dispose()):n!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(e){if(this.renderer=e,null!==e){const t=e.getSize(new o.FM8),n=e.getContext().getContextAttributes().alpha,i=this.inputBuffer.texture.type;i===o.ywz&&e.outputEncoding===o.knz&&(this.inputBuffer.texture.encoding=o.knz,this.outputBuffer.texture.encoding=o.knz,this.inputBuffer.dispose(),this.outputBuffer.dispose()),e.autoClear=!1,this.setSize(t.width,t.height);for(const r of this.passes)r.initialize(e,n,i)}}replaceRenderer(e,t=!0){const n=this.renderer,i=n.domElement.parentNode;return this.setRenderer(e),t&&null!==i&&(i.removeChild(n.domElement),i.appendChild(e.domElement)),n}createDepthTexture(){const e=this.depthTexture=new o.$YQ;return this.inputBuffer.depthTexture=e,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(e.format=o.brP,e.type=o.wJv):e.type=o.JQ4,e}deleteDepthTexture(){if(null!==this.depthTexture){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const e of this.passes)e.setDepthTexture(null)}}createBuffer(e,t,n,i){const r=this.renderer,s=null===r?new o.FM8:r.getDrawingBufferSize(new o.FM8),a={minFilter:o.wem,magFilter:o.wem,stencilBuffer:t,depthBuffer:e,type:n};let l;return i>0?(l=Number(o.UZH.replace(/\D+/g,""))<138?new o.p7A(s.width,s.height,a):new o.dd2(s.width,s.height,a),l.ignoreDepthForMultisampleCopy=!1,l.samples=i):l=new o.dd2(s.width,s.height,a),n===o.ywz&&null!==r&&r.outputEncoding===o.knz&&(l.texture.encoding=o.knz),l.texture.name="EffectComposer.Buffer",l.texture.generateMipmaps=!1,l}addPass(e,t){const n=this.passes,i=this.renderer,r=i.getDrawingBufferSize(new o.FM8),s=i.getContext().getContextAttributes().alpha,a=this.inputBuffer.texture.type;if(e.setRenderer(i),e.setSize(r.width,r.height),e.initialize(i,s,a),this.autoRenderToScreen&&(n.length>0&&(n[n.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),void 0!==t?n.splice(t,0,e):n.push(e),this.autoRenderToScreen&&(n[n.length-1].renderToScreen=!0),e.needsDepthTexture||null!==this.depthTexture)if(null===this.depthTexture){const l=this.createDepthTexture();for(e of n)e.setDepthTexture(l)}else e.setDepthTexture(this.depthTexture)}removePass(e){const t=this.passes,n=t.indexOf(e);-1!==n&&t.splice(n,1).length>0&&(null!==this.depthTexture&&(t.reduce((l,c)=>l||c.needsDepthTexture,!1)||(e.getDepthTexture()===this.depthTexture&&e.setDepthTexture(null),this.deleteDepthTexture())),this.autoRenderToScreen&&n===t.length&&(e.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0)))}removeAllPasses(){const e=this.passes;this.deleteDepthTexture(),e.length>0&&(this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!1),this.passes=[])}render(e){const t=this.renderer,n=this.copyPass;let a,l,c,i=this.inputBuffer,r=this.outputBuffer,s=!1;void 0===e&&(e=this.timer.update().getDelta());for(const u of this.passes)u.enabled&&(u.render(t,i,r,e,s),u.needsSwap&&(s&&(n.renderToScreen=u.renderToScreen,a=t.getContext(),l=t.state.buffers.stencil,l.setFunc(a.NOTEQUAL,1,4294967295),n.render(t,i,r,e,s),l.setFunc(a.EQUAL,1,4294967295)),c=i,i=r,r=c),u instanceof hn?s=!0:u instanceof ln&&(s=!1))}setSize(e,t,n){const i=this.renderer;if(void 0===e||void 0===t){const s=i.getSize(new o.FM8);e=s.width,t=s.height}i.setSize(e,t,n);const r=i.getDrawingBufferSize(new o.FM8);this.inputBuffer.setSize(r.width,r.height),this.outputBuffer.setSize(r.width,r.height);for(const s of this.passes)s.setSize(r.width,r.height)}reset(){const e=this.timer.isAutoResetEnabled();this.dispose(),this.autoRenderToScreen=!0,this.timer.setAutoResetEnabled(e)}dispose(){for(const e of this.passes)e.dispose();this.passes=[],null!==this.inputBuffer&&this.inputBuffer.dispose(),null!==this.outputBuffer&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose()}},En=class{constructor(){this.shaderParts=new Map([[y.FRAGMENT_HEAD,null],[y.FRAGMENT_MAIN_UV,null],[y.FRAGMENT_MAIN_IMAGE,null],[y.VERTEX_HEAD,null],[y.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=0,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=o.rnI}};Set;var $n=new Map([[E.ADD,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y,opacity);}"],[E.ALPHA,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,min(y.a,opacity));}"],[E.AVERAGE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y)*0.5,opacity);}"],[E.COLOR,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.rg,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}"],[E.COLOR_BURN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(step(0.0,y)*(1.0-min(vec4(1.0),(1.0-x)/y)),vec4(1.0),step(1.0,x));return mix(x,z,opacity);}"],[E.COLOR_DODGE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=step(0.0,x)*mix(min(vec4(1.0),x/max(1.0-y,1e-9)),vec4(1.0),step(1.0,y));return mix(x,z,opacity);}"],[E.DARKEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x,y),opacity);}"],[E.DIFFERENCE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,abs(x-y),opacity);}"],[E.DIVIDE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x/max(y,1e-12),opacity);}"],[E.DST,null],[E.EXCLUSION,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y-2.0*x*y),opacity);}"],[E.HARD_LIGHT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(2.0*x*y,1.0-2.0*(1.0-x)*(1.0-y),step(0.5,y));return mix(x,z,opacity);}"],[E.HARD_MIX,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,step(1.0,x+y),opacity);}"],[E.HUE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.r,xHSL.gb));return vec4(mix(x.rgb,z,opacity),y.a);}"],[E.INVERT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-y,opacity);}"],[E.INVERT_RGB,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y*(1.0-x),opacity);}"],[E.LIGHTEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x,y),opacity);}"],[E.LINEAR_BURN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(y+x-1.0,0.0,1.0),opacity);}"],[E.LINEAR_DODGE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x+y,1.0),opacity);}"],[E.LINEAR_LIGHT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(2.0*y+x-1.0,0.0,1.0),opacity);}"],[E.LUMINOSITY,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.rg,yHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}"],[E.MULTIPLY,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x*y,opacity);}"],[E.NEGATION,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-abs(1.0-x-y),opacity);}"],[E.NORMAL,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,opacity);}"],[E.OVERLAY,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(2.0*y*x,1.0-2.0*(1.0-y)*(1.0-x),step(0.5,x));return mix(x,z,opacity);}"],[E.PIN_LIGHT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 z=mix(mix(y2,x,step(0.5*x,y)),max(vec4(0.0),y2-1.0),step(x,(y2-1.0)));return mix(x,z,opacity);}"],[E.REFLECT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,mix(min(x*x/max(1.0-y,1e-12),1.0),y,step(1.0,y)),opacity);}"],[E.SATURATION,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.r,yHSL.g,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}"],[E.SCREEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y-x*y,opacity);}"],[E.SOFT_LIGHT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 w=step(0.5,y);vec4 z=mix(x-(1.0-y2)*x*(1.0-x),mix(x+(y2-1.0)*(sqrt(x)-x),x+(y2-1.0)*x*((16.0*x-12.0)*x+3.0),w*(1.0-step(0.25,x))),w);return mix(x,z,opacity);}"],[E.SRC,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y;}"],[E.SUBTRACT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x+y-1.0,0.0),opacity);}"],[E.VIVID_LIGHT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(max(vec4(0.0),1.0-min(vec4(1.0),(1.0-x)/(2.0*y))),min(vec4(1.0),x/(2.0*(1.0-y))),step(0.5,y));return mix(x,z,opacity);}"]]),ei=class extends o.pBf{constructor(e,t=1){super(),this._blendFunction=e,this.opacity=new o.xWb(t)}getOpacity(){return this.opacity.value}setOpacity(e){this.opacity.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(e){this.blendFunction=e}getShaderCode(){return $n.get(this.blendFunction)}},ft=class extends o.pBf{constructor(e,t,{attributes:n=0,blendFunction:i=E.NORMAL,defines:r=new Map,uniforms:s=new Map,extensions:a=null,vertexShader:l=null}={}){super(),this.name=e,this.renderer=null,this.attributes=n,this.fragmentShader=t,this.vertexShader=l,this.defines=r,this.uniforms=s,this.extensions=a,this.blendMode=new ei(i),this.blendMode.addEventListener("change",c=>this.setChanged()),this._inputColorSpace=o.rnI,this._outputColorSpace=null}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}getName(){return this.name}setRenderer(e){this.renderer=e}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(e){this.fragmentShader=e,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(e){this.vertexShader=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(e,t=o.z81){}update(e,t,n){}setSize(e,t){}initialize(e,t,n){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof o.dd2||t instanceof o.F5T||t instanceof o.xEZ||t instanceof K)&&this[e].dispose()}}},ni=class extends ft{constructor({blendFunction:e=E.SCREEN,luminanceThreshold:t=.9,luminanceSmoothing:n=.025,mipmapBlur:i=!1,intensity:r=1,radius:s=.85,levels:a=8,kernelSize:l=M.LARGE,resolutionScale:c=.5,width:u=I.AUTO_SIZE,height:d=I.AUTO_SIZE,resolutionX:g=u,resolutionY:p=d}={}){super("BloomEffect","#ifdef FRAMEBUFFER_PRECISION_HIGH\nuniform mediump sampler2D map;\n#else\nuniform lowp sampler2D map;\n#endif\nuniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=texture2D(map,uv)*intensity;}",{blendFunction:e,uniforms:new Map([["map",new o.xWb(null)],["intensity",new o.xWb(r)]])}),this.renderTarget=new o.dd2(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new _e({kernelSize:l}),this.luminancePass=new Tt({colorOutput:!0}),this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=n,this.mipmapBlurPass=new gn,this.mipmapBlurPass.enabled=i,this.mipmapBlurPass.radius=s,this.mipmapBlurPass.levels=a,this.uniforms.get("map").value=i?this.mipmapBlurPass.texture:this.renderTarget.texture;const v=this.resolution=new I(this,g,p,c);v.addEventListener("change",x=>this.setSize(v.baseWidth,v.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get distinction(){return console.warn(this.name,"distinction was removed"),1}set distinction(e){console.warn(this.name,"distinction was removed")}get intensity(){return this.uniforms.get("intensity").value}set intensity(e){this.uniforms.get("intensity").value=e}getIntensity(){return this.intensity}setIntensity(e){this.intensity=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}update(e,t,n){const i=this.renderTarget,r=this.luminancePass;r.enabled?(r.render(e,t),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,r.renderTarget):this.blurPass.render(e,r.renderTarget,i)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,t):this.blurPass.render(e,t,i)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t),this.renderTarget.setSize(n.width,n.height),this.blurPass.resolution.copy(n),this.luminancePass.setSize(e,t),this.mipmapBlurPass.setSize(e,t)}initialize(e,t,n){this.blurPass.initialize(e,t,n),this.luminancePass.initialize(e,t,n),this.mipmapBlurPass.initialize(e,t,n),void 0!==n&&(this.renderTarget.texture.type=n,e.outputEncoding===o.knz&&(this.renderTarget.texture.encoding=o.knz))}},dt=class extends o.IEO{constructor(e,t,n=o.Y8D,i=o.ywz){super(function pi(e,t,n){const i=new Map([[o.Y8D,1],[o.hEm,1],[o.av9,2],[o.wk1,4]]);let r;if(i.has(t)||console.error("Invalid noise texture format"),n===o.ywz){r=new Uint8Array(e*i.get(t));for(let s=0,a=r.length;s<a;++s)r[s]=255*Math.random()+.5}else{r=new Float32Array(e*i.get(t));for(let s=0,a=r.length;s<a;++s)r[s]=Math.random()}return r}(e*t,n,i),e,t,n,i),this.needsUpdate=!0}};function yt(e,t,n){const i=document.createElement("canvas"),r=i.getContext("2d");if(i.width=e,i.height=t,n instanceof Image)r.drawImage(n,0,0);else{const s=r.createImageData(e,t);s.data.set(n),r.putImageData(s,0,0)}return i}new o.Pa4,new o.yGw;var ge=class{constructor(e=0,t=0,n=null){this.width=e,this.height=t,this.data=n}toCanvas(){return typeof document>"u"?null:yt(this.width,this.height,this.data)}static from(e){const{width:t,height:n}=e;let i;if(e instanceof Image){const r=yt(t,n,e);null!==r&&(i=r.getContext("2d").getImageData(0,0,t,n).data)}else i=e.data;return new ge(t,n,i)}},Pt=new o.Ilk,Me=class extends o.zob{constructor(e,t){super(e,t,t,t),this.type=o.VzW,this.format=o.wk1,this.encoding=o.rnI,this.minFilter=o.wem,this.magFilter=o.wem,this.wrapS=o.uWy,this.wrapT=o.uWy,this.wrapR=o.uWy,this.unpackAlignment=1,this.needsUpdate=!0,this.domainMin=new o.Pa4(0,0,0),this.domainMax=new o.Pa4(1,1,1)}get isLookupTexture3D(){return!0}scaleUp(e,t=!0){const n=this.image;let i;return i=e<=n.width?Promise.reject(new Error("The target size must be greater than the current size")):new Promise((r,s)=>{const a=URL.createObjectURL(new Blob(['"use strict";(()=>{var O=Math.pow;var _={SCALE_UP:"lut.scaleup"};var k=[new Float32Array(3),new Float32Array(3)],n=[new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3)],Z=[[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([0,1,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([0,1,1]),new Float32Array([1,1,1])]];function d(a,t,r,m){let i=r[0]-t[0],e=r[1]-t[1],y=r[2]-t[2],h=a[0]-t[0],A=a[1]-t[1],w=a[2]-t[2],c=e*w-y*A,l=y*h-i*w,x=i*A-e*h,u=Math.sqrt(c*c+l*l+x*x),b=u*.5,s=c/u,F=l/u,f=x/u,p=-(a[0]*s+a[1]*F+a[2]*f),M=m[0]*s+m[1]*F+m[2]*f;return Math.abs(M+p)*b/3}function V(a,t,r,m,i,e){let y=(r+m*t+i*t*t)*4;e[0]=a[y+0],e[1]=a[y+1],e[2]=a[y+2]}function j(a,t,r,m,i,e){let y=r*(t-1),h=m*(t-1),A=i*(t-1),w=Math.floor(y),c=Math.floor(h),l=Math.floor(A),x=Math.ceil(y),u=Math.ceil(h),b=Math.ceil(A),s=y-w,F=h-c,f=A-l;if(w===y&&c===h&&l===A)V(a,t,y,h,A,e);else{let p;s>=F&&F>=f?p=Z[0]:s>=f&&f>=F?p=Z[1]:f>=s&&s>=F?p=Z[2]:F>=s&&s>=f?p=Z[3]:F>=f&&f>=s?p=Z[4]:f>=F&&F>=s&&(p=Z[5]);let[M,g,X,Y]=p,P=k[0];P[0]=s,P[1]=F,P[2]=f;let o=k[1],L=x-w,S=u-c,U=b-l;o[0]=L*M[0]+w,o[1]=S*M[1]+c,o[2]=U*M[2]+l,V(a,t,o[0],o[1],o[2],n[0]),o[0]=L*g[0]+w,o[1]=S*g[1]+c,o[2]=U*g[2]+l,V(a,t,o[0],o[1],o[2],n[1]),o[0]=L*X[0]+w,o[1]=S*X[1]+c,o[2]=U*X[2]+l,V(a,t,o[0],o[1],o[2],n[2]),o[0]=L*Y[0]+w,o[1]=S*Y[1]+c,o[2]=U*Y[2]+l,V(a,t,o[0],o[1],o[2],n[3]);let T=d(g,X,Y,P)*6,q=d(M,X,Y,P)*6,C=d(M,g,Y,P)*6,E=d(M,g,X,P)*6;n[0][0]*=T,n[0][1]*=T,n[0][2]*=T,n[1][0]*=q,n[1][1]*=q,n[1][2]*=q,n[2][0]*=C,n[2][1]*=C,n[2][2]*=C,n[3][0]*=E,n[3][1]*=E,n[3][2]*=E,e[0]=n[0][0]+n[1][0]+n[2][0]+n[3][0],e[1]=n[0][1]+n[1][1]+n[2][1]+n[3][1],e[2]=n[0][2]+n[1][2]+n[2][2]+n[3][2]}}var v=class{static expand(t,r){let m=Math.cbrt(t.length/4),i=new Float32Array(3),e=new t.constructor(O(r,3)*4),y=t instanceof Uint8Array?255:1,h=O(r,2),A=1/(r-1);for(let w=0;w<r;++w)for(let c=0;c<r;++c)for(let l=0;l<r;++l){let x=l*A,u=c*A,b=w*A,s=Math.round(l+c*r+w*h)*4;j(t,m,x,u,b,i),e[s+0]=i[0],e[s+1]=i[1],e[s+2]=i[2],e[s+3]=y}return e}};self.addEventListener("message",a=>{let t=a.data,r=t.data;switch(t.operation){case _.SCALE_UP:r=v.expand(r,t.size);break}postMessage(r,[r.buffer]),close()});})();\n'],{type:"text/javascript"})),l=new Worker(a);l.addEventListener("error",u=>s(u.error)),l.addEventListener("message",u=>{const d=new Me(u.data,e);d.encoding=this.encoding,d.type=this.type,d.name=this.name,URL.revokeObjectURL(a),r(d)}),l.postMessage({operation:"lut.scaleup",data:n.data,size:e},t?[n.data.buffer]:[])}),i}applyLUT(e){const t=this.image,n=e.image,i=Math.min(t.width,t.height,t.depth);if(i!==Math.min(n.width,n.height,n.depth))console.error("Size mismatch");else if(e.type!==o.VzW||this.type!==o.VzW)console.error("Both LUTs must be FloatType textures");else if(e.format!==o.wk1||this.format!==o.wk1)console.error("Both LUTs must be RGBA textures");else{const s=t.data,a=n.data,l=i,c=l**2,u=l-1;for(let d=0,g=l**3;d<g;++d){const p=4*d,T=4*Math.round(s[p+0]*u+s[p+1]*u*l+s[p+2]*u*c);s[p+0]=a[T+0],s[p+1]=a[T+1],s[p+2]=a[T+2]}this.needsUpdate=!0}return this}convertToUint8(){if(this.type===o.VzW){const e=this.image.data,t=new Uint8Array(e.length);for(let n=0,i=e.length;n<i;++n)t[n]=255*e[n]+.5;this.image.data=t,this.type=o.ywz,this.needsUpdate=!0}return this}convertToFloat(){if(this.type===o.ywz){const e=this.image.data,t=new Float32Array(e.length);for(let n=0,i=e.length;n<i;++n)t[n]=e[n]/255;this.image.data=t,this.type=o.VzW,this.needsUpdate=!0}return this}convertToRGBA(){return console.warn("LookupTexture","convertToRGBA() is deprecated, LUTs are now RGBA by default"),this}convertLinearToSRGB(){const e=this.image.data;if(this.type===o.VzW){for(let t=0,n=e.length;t<n;t+=4)Pt.fromArray(e,t).convertLinearToSRGB().toArray(e,t);this.encoding=o.knz,this.needsUpdate=!0}else console.error("Color space conversion requires FloatType data");return this}convertSRGBToLinear(){const e=this.image.data;if(this.type===o.VzW){for(let t=0,n=e.length;t<n;t+=4)Pt.fromArray(e,t).convertSRGBToLinear().toArray(e,t);this.encoding=o.rnI,this.needsUpdate=!0}else console.error("Color space conversion requires FloatType data");return this}toDataTexture(){const n=new o.IEO(this.image.data,this.image.width,this.image.height*this.image.depth);return n.name=this.name,n.type=this.type,n.format=this.format,n.encoding=this.encoding,n.minFilter=o.wem,n.magFilter=o.wem,n.wrapS=this.wrapS,n.wrapT=this.wrapT,n.generateMipmaps=!1,n.needsUpdate=!0,n}static from(e){const t=e.image,{width:n,height:i}=t,r=Math.min(n,i);let s;if(t instanceof Image){const c=ge.from(t).data;if(n>i){s=new Uint8Array(c.length);for(let u=0;u<r;++u)for(let d=0;d<r;++d)for(let g=0;g<r;++g){const p=4*(g+u*r+d*r*r),v=4*(g+d*r+u*r*r);s[v+0]=c[p+0],s[v+1]=c[p+1],s[v+2]=c[p+2],s[v+3]=c[p+3]}}else s=new Uint8Array(c.buffer)}else s=t.data.slice();const a=new Me(s,r);return a.encoding=e.encoding,a.type=e.type,a.name=e.name,a}static createNeutral(e){const t=new Float32Array(e**3*4),n=e**2,i=1/(e-1);for(let s=0;s<e;++s)for(let a=0;a<e;++a)for(let l=0;l<e;++l){const c=4*(s+a*e+l*n);t[c+0]=s*i,t[c+1]=a*i,t[c+2]=l*i,t[c+3]=1}const r=new Me(t,e);return r.name="neutral",r}};function vt(e,t,n){return e+(t-e)*n}function X(e,t,n,i){const r=vt(e,t,.75),s=vt(n,i,.75);return vt(r,s,.875)}new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1]),new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,0,1]),new Float32Array([1,1,1]),new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([1,0,1]),new Float32Array([1,1,1]),new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1]),new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([0,1,1]),new Float32Array([1,1,1]),new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([0,1,1]),new Float32Array([1,1,1]),new Float32Array(2),new Float32Array(2),new Float32Array([0,-.25,.25,-.125,.125,-.375,.375]),new Float32Array([0,0]),new Float32Array([.25,-.25]),new Float32Array([-.25,.25]),new Float32Array([.125,-.125]),new Float32Array([-.125,.125]),new Uint8Array([0,0]),new Uint8Array([3,0]),new Uint8Array([0,3]),new Uint8Array([3,3]),new Uint8Array([1,0]),new Uint8Array([4,0]),new Uint8Array([1,3]),new Uint8Array([4,3]),new Uint8Array([0,1]),new Uint8Array([3,1]),new Uint8Array([0,4]),new Uint8Array([3,4]),new Uint8Array([1,1]),new Uint8Array([4,1]),new Uint8Array([1,4]),new Uint8Array([4,4]),new Uint8Array([0,0]),new Uint8Array([1,0]),new Uint8Array([0,2]),new Uint8Array([1,2]),new Uint8Array([2,0]),new Uint8Array([3,0]),new Uint8Array([2,2]),new Uint8Array([3,2]),new Uint8Array([0,1]),new Uint8Array([1,1]),new Uint8Array([0,3]),new Uint8Array([1,3]),new Uint8Array([2,1]),new Uint8Array([3,1]),new Uint8Array([2,3]),new Uint8Array([3,3]),X(0,0,0,0),new Float32Array([0,0,0,0]),X(0,0,0,1),new Float32Array([0,0,0,1]),X(0,0,1,0),new Float32Array([0,0,1,0]),X(0,0,1,1),new Float32Array([0,0,1,1]),X(0,1,0,0),new Float32Array([0,1,0,0]),X(0,1,0,1),new Float32Array([0,1,0,1]),X(0,1,1,0),new Float32Array([0,1,1,0]),X(0,1,1,1),new Float32Array([0,1,1,1]),X(1,0,0,0),new Float32Array([1,0,0,0]),X(1,0,0,1),new Float32Array([1,0,0,1]),X(1,0,1,0),new Float32Array([1,0,1,0]),X(1,0,1,1),new Float32Array([1,0,1,1]),X(1,1,0,0),new Float32Array([1,1,0,0]),X(1,1,0,1),new Float32Array([1,1,0,1]),X(1,1,1,0),new Float32Array([1,1,1,0]),X(1,1,1,1),new Float32Array([1,1,1,1]);var Ni=class extends ft{constructor(e,{blendFunction:t=E.SRC,tetrahedralInterpolation:n=!1,inputEncoding:i=o.knz}={}){super("LUT3DEffect","uniform vec3 scale;uniform vec3 offset;\n#ifdef CUSTOM_INPUT_DOMAIN\nuniform vec3 domainMin;uniform vec3 domainMax;\n#endif\n#ifdef LUT_3D\n#ifdef LUT_PRECISION_HIGH\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler3D lut;\n#else\nuniform mediump sampler3D lut;\n#endif\n#else\nuniform lowp sampler3D lut;\n#endif\nvec4 applyLUT(const in vec3 rgb){\n#ifdef TETRAHEDRAL_INTERPOLATION\nvec3 p=floor(rgb);vec3 f=rgb-p;vec3 v1=(p+0.5)*LUT_TEXEL_WIDTH;vec3 v4=(p+1.5)*LUT_TEXEL_WIDTH;vec3 v2,v3;vec3 frac;if(f.r>=f.g){if(f.g>f.b){frac=f.rgb;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else if(f.r>=f.b){frac=f.rbg;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v1.y,v4.z);}else{frac=f.brg;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v4.x,v1.y,v4.z);}}else{if(f.b>f.g){frac=f.bgr;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v1.x,v4.y,v4.z);}else if(f.r>=f.b){frac=f.grb;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else{frac=f.gbr;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v1.x,v4.y,v4.z);}}vec4 n1=texture(lut,v1);vec4 n2=texture(lut,v2);vec4 n3=texture(lut,v3);vec4 n4=texture(lut,v4);vec4 weights=vec4(1.0-frac.x,frac.x-frac.y,frac.y-frac.z,frac.z);vec4 result=weights*mat4(vec4(n1.r,n2.r,n3.r,n4.r),vec4(n1.g,n2.g,n3.g,n4.g),vec4(n1.b,n2.b,n3.b,n4.b),vec4(1.0));return vec4(result.rgb,1.0);\n#else\nreturn texture(lut,rgb);\n#endif\n}\n#else\n#ifdef LUT_PRECISION_HIGH\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D lut;\n#else\nuniform mediump sampler2D lut;\n#endif\n#else\nuniform lowp sampler2D lut;\n#endif\nvec4 applyLUT(const in vec3 rgb){float slice=rgb.b*LUT_SIZE;float slice0=floor(slice);float interp=slice-slice0;float centeredInterp=interp-0.5;float slice1=slice0+sign(centeredInterp);\n#ifdef LUT_STRIP_HORIZONTAL\nfloat xOffset=clamp(rgb.r*LUT_TEXEL_HEIGHT,LUT_TEXEL_WIDTH*0.5,LUT_TEXEL_HEIGHT-LUT_TEXEL_WIDTH*0.5);vec2 uv0=vec2(slice0*LUT_TEXEL_HEIGHT+xOffset,rgb.g);vec2 uv1=vec2(slice1*LUT_TEXEL_HEIGHT+xOffset,rgb.g);\n#else\nfloat yOffset=clamp(rgb.g*LUT_TEXEL_WIDTH,LUT_TEXEL_HEIGHT*0.5,LUT_TEXEL_WIDTH-LUT_TEXEL_HEIGHT*0.5);vec2 uv0=vec2(rgb.r,slice0*LUT_TEXEL_WIDTH+yOffset);vec2 uv1=vec2(rgb.r,slice1*LUT_TEXEL_WIDTH+yOffset);\n#endif\nvec4 sample0=texture2D(lut,uv0);vec4 sample1=texture2D(lut,uv1);return mix(sample0,sample1,abs(centeredInterp));}\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 c=inputColor.rgb;\n#ifdef CUSTOM_INPUT_DOMAIN\nif(c.r>=domainMin.r&&c.g>=domainMin.g&&c.b>=domainMin.b&&c.r<=domainMax.r&&c.g<=domainMax.g&&c.b<=domainMax.b){c=applyLUT(scale*c+offset).rgb;}else{c=inputColor.rgb;}\n#else\n#if !defined(LUT_3D) || defined(TETRAHEDRAL_INTERPOLATION)\nc=clamp(c,0.0,1.0);\n#endif\nc=applyLUT(scale*c+offset).rgb;\n#endif\noutputColor=vec4(c,inputColor.a);}",{blendFunction:t,uniforms:new Map([["lut",new o.xWb(null)],["scale",new o.xWb(new o.Pa4)],["offset",new o.xWb(new o.Pa4)],["domainMin",new o.xWb(null)],["domainMax",new o.xWb(null)]])}),this.tetrahedralInterpolation=n,this.inputColorSpace=i,this.lut=e}get inputEncoding(){return this.inputColorSpace}set inputEncoding(e){this.inputColorSpace=e}getInputEncoding(){return this.inputColorSpace}setInputEncoding(e){this.inputColorSpace=e}getOutputEncoding(){return this.outputColorSpace}get lut(){return this.uniforms.get("lut").value}set lut(e){const t=this.defines,n=this.uniforms;if(this.lut!==e&&(n.get("lut").value=e,null!==e)){const i=e.image,r=this.tetrahedralInterpolation;if(t.clear(),t.set("LUT_SIZE",Math.min(i.width,i.height).toFixed(16)),t.set("LUT_TEXEL_WIDTH",(1/i.width).toFixed(16)),t.set("LUT_TEXEL_HEIGHT",(1/i.height).toFixed(16)),n.get("domainMin").value=null,n.get("domainMax").value=null,(e.type===o.VzW||e.type===o.cLu)&&t.set("LUT_PRECISION_HIGH","1"),i.width>i.height?t.set("LUT_STRIP_HORIZONTAL","1"):e instanceof o.zob&&t.set("LUT_3D","1"),e instanceof Me){const s=e.domainMin,a=e.domainMax;(0!==s.x||0!==s.y||0!==s.z||1!==a.x||1!==a.y||1!==a.z)&&(t.set("CUSTOM_INPUT_DOMAIN","1"),n.get("domainMin").value=s.clone(),n.get("domainMax").value=a.clone())}this.tetrahedralInterpolation=r}}getLUT(){return this.lut}setLUT(e){this.lut=e}updateScaleOffset(){const e=this.lut;if(null!==e){const t=Math.min(e.image.width,e.image.height),n=this.uniforms.get("scale").value,i=this.uniforms.get("offset").value;if(this.tetrahedralInterpolation&&e instanceof o.zob)if(this.defines.has("CUSTOM_INPUT_DOMAIN")){const r=e.domainMax.clone().sub(e.domainMin);n.setScalar(t-1).divide(r),i.copy(e.domainMin).negate().multiply(n)}else n.setScalar(t-1),i.setScalar(0);else if(this.defines.has("CUSTOM_INPUT_DOMAIN")){const r=e.domainMax.clone().sub(e.domainMin).multiplyScalar(t);n.setScalar(t-1).divide(r),i.copy(e.domainMin).negate().multiply(n).addScalar(1/(2*t))}else n.setScalar((t-1)/t),i.setScalar(1/(2*t))}}configureTetrahedralInterpolation(){const e=this.lut;null!==e&&(e.minFilter=o.wem,e.magFilter=o.wem,this.tetrahedralInterpolation&&(e instanceof o.zob?(e.minFilter=o.TyD,e.magFilter=o.TyD):console.warn("Tetrahedral interpolation requires a 3D texture")),void 0===e.source&&(e.needsUpdate=!0))}get tetrahedralInterpolation(){return this.defines.has("TETRAHEDRAL_INTERPOLATION")}set tetrahedralInterpolation(e){e?this.defines.set("TETRAHEDRAL_INTERPOLATION","1"):this.defines.delete("TETRAHEDRAL_INTERPOLATION"),this.configureTetrahedralInterpolation(),this.updateScaleOffset(),this.setChanged()}setTetrahedralInterpolationEnabled(e){this.tetrahedralInterpolation=e}},ji=(Math,new o.Pa4,new o.Pa4,class extends ft{constructor(e,t,{blendFunction:n=E.MULTIPLY,distanceScaling:i=!0,depthAwareUpsampling:r=!0,normalDepthBuffer:s=null,samples:a=9,rings:l=7,worldDistanceThreshold:c,worldDistanceFalloff:u,worldProximityThreshold:d,worldProximityFalloff:g,distanceThreshold:p=.97,distanceFalloff:v=.03,rangeThreshold:x=5e-4,rangeFalloff:C=.001,minRadiusScale:T=.1,luminanceInfluence:b=.7,radius:U=.1825,intensity:F=1,bias:H=.025,fade:J=.01,color:$=null,resolutionScale:k=1,width:S=I.AUTO_SIZE,height:Pe=I.AUTO_SIZE,resolutionX:Ie=S,resolutionY:be=Pe}={}){super("SSAOEffect","uniform lowp sampler2D aoBuffer;uniform float luminanceInfluence;\n#ifdef DEPTH_AWARE_UPSAMPLING\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D normalDepthBuffer;\n#else\nuniform mediump sampler2D normalDepthBuffer;\n#endif\n#endif\n#ifdef COLORIZE\nuniform vec3 color;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,const in float depth,out vec4 outputColor){float aoLinear=texture2D(aoBuffer,uv).r;\n#if defined(DEPTH_AWARE_UPSAMPLING) && __VERSION__ == 300\nvec4 normalDepth[4];normalDepth[0]=textureOffset(normalDepthBuffer,uv,ivec2(0,0));normalDepth[1]=textureOffset(normalDepthBuffer,uv,ivec2(0,1));normalDepth[2]=textureOffset(normalDepthBuffer,uv,ivec2(1,0));normalDepth[3]=textureOffset(normalDepthBuffer,uv,ivec2(1,1));float dot01=dot(normalDepth[0].rgb,normalDepth[1].rgb);float dot02=dot(normalDepth[0].rgb,normalDepth[2].rgb);float dot03=dot(normalDepth[0].rgb,normalDepth[3].rgb);float minDot=min(dot01,min(dot02,dot03));float s=step(THRESHOLD,minDot);float smallestDistance=1.0;int index;for(int i=0;i<4;++i){float distance=abs(depth-normalDepth[i].a);if(distance<smallestDistance){smallestDistance=distance;index=i;}}ivec2 offsets[4];offsets[0]=ivec2(0,0);offsets[1]=ivec2(0,1);offsets[2]=ivec2(1,0);offsets[3]=ivec2(1,1);ivec2 coord=ivec2(uv*vec2(textureSize(aoBuffer,0)))+offsets[index];float aoNearest=texelFetch(aoBuffer,coord,0).r;float ao=mix(aoNearest,aoLinear,s);\n#else\nfloat ao=aoLinear;\n#endif\nfloat l=linearToRelativeLuminance(inputColor.rgb);ao=mix(ao,1.0,l*luminanceInfluence);\n#ifdef COLORIZE\noutputColor=vec4(1.0-(1.0-ao)*(1.0-color),inputColor.a);\n#else\noutputColor=vec4(vec3(ao),inputColor.a);\n#endif\n}",{blendFunction:n,attributes:1,defines:new Map([["THRESHOLD","0.997"]]),uniforms:new Map([["aoBuffer",new o.xWb(null)],["normalDepthBuffer",new o.xWb(s)],["luminanceInfluence",new o.xWb(b)],["color",new o.xWb(null)],["scale",new o.xWb(0)]])}),this.renderTargetAO=new o.dd2(1,1,{depthBuffer:!1}),this.renderTargetAO.texture.name="AO.Target",this.uniforms.get("aoBuffer").value=this.renderTargetAO.texture;const Ee=this.resolution=new I(this,Ie,be,k);Ee.addEventListener("change",Xe=>this.setSize(Ee.baseWidth,Ee.baseHeight)),this.camera=e,this.ssaoPass=new q(new en(e));const De=new dt(64,64,o.wk1);De.wrapS=De.wrapT=o.rpg;const G=this.ssaoMaterial;G.noiseTexture=De,G.minRadiusScale=T,G.intensity=F,G.fade=J,G.bias=H,null!==s?(G.normalDepthBuffer=s,this.depthAwareUpsampling=r):G.normalBuffer=t,G.distanceThreshold=p,G.distanceFalloff=v,G.proximityThreshold=x,G.proximityFalloff=C,void 0!==c&&(G.worldDistanceThreshold=c),void 0!==u&&(G.worldDistanceFalloff=u),void 0!==d&&(G.worldProximityThreshold=d),void 0!==g&&(G.worldProximityFalloff=g),G.distanceScaling=i,G.samples=a,G.radius=U,G.rings=l,this.color=$}getResolution(){return this.resolution}get ssaoMaterial(){return this.ssaoPass.fullscreenMaterial}getSSAOMaterial(){return this.ssaoMaterial}get samples(){return this.ssaoMaterial.samples}set samples(e){this.ssaoMaterial.samples=e}get rings(){return this.ssaoMaterial.rings}set rings(e){this.ssaoMaterial.rings=e}get radius(){return this.ssaoMaterial.radius}set radius(e){this.ssaoMaterial.radius=e}get depthAwareUpsampling(){return this.defines.has("DEPTH_AWARE_UPSAMPLING")}set depthAwareUpsampling(e){this.depthAwareUpsampling!==e&&(e&&null!==this.uniforms.get("normalDepthBuffer").value?this.defines.set("DEPTH_AWARE_UPSAMPLING","1"):this.defines.delete("DEPTH_AWARE_UPSAMPLING"),this.setChanged())}isDepthAwareUpsamplingEnabled(){return this.depthAwareUpsampling}setDepthAwareUpsamplingEnabled(e){this.depthAwareUpsampling=e}get distanceScaling(){return this.ssaoMaterial.distanceScaling}set distanceScaling(e){this.ssaoMaterial.distanceScaling=e}get color(){return this.uniforms.get("color").value}set color(e){const t=this.uniforms,n=this.defines;null!==e?n.has("COLORIZE")?t.get("color").value.set(e):(n.set("COLORIZE","1"),t.get("color").value=new o.Ilk(e),this.setChanged()):n.has("COLORIZE")&&(n.delete("COLORIZE"),t.get("color").value=null,this.setChanged())}get luminanceInfluence(){return this.uniforms.get("luminanceInfluence").value}set luminanceInfluence(e){this.uniforms.get("luminanceInfluence").value=e}getColor(){return this.color}setColor(e){this.color=e}setDistanceCutoff(e,t){this.ssaoMaterial.distanceThreshold=e,this.ssaoMaterial.distanceFalloff=t}setProximityCutoff(e,t){this.ssaoMaterial.proximityThreshold=e,this.ssaoMaterial.proximityFalloff=t}setDepthTexture(e,t=o.z81){this.ssaoMaterial.depthBuffer=e,this.ssaoMaterial.depthPacking=t}update(e,t,n){this.ssaoPass.render(e,null,this.renderTargetAO)}setSize(e,t){const n=this.resolution;n.setBaseSize(e,t);const i=n.width,r=n.height,s=this.ssaoMaterial;s.adoptCameraSettings(this.camera),s.setSize(i,r),this.renderTargetAO.setSize(i,r)}}),$i=class extends o.aNw{load(e,t=(()=>{}),n=(()=>{}),i=null){const r=this.manager,s=new o.lLk,a=new o.hH6(s);return a.setPath(this.path),a.setResponseType("text"),new Promise((l,c)=>{s.onError=u=>{r.itemError(u),null!==i?(i(`Failed to load ${u}`),l()):c(`Failed to load ${u}`)},r.itemStart(e),a.load(e,u=>{try{const d=this.parse(u);r.itemEnd(e),t(d),l(d)}catch(d){console.error(d),s.onError(e)}},n)})}parse(e){const s=/^([\d.e+-]+) +([\d.e+-]+) +([\d.e+-]+) *$/gm;let a=/TITLE +"([^"]*)"/.exec(e);const l=null!==a?a[1]:null;if(a=/LUT_3D_SIZE +(\d+)/.exec(e),null===a)throw new Error("Missing LUT_3D_SIZE information");const c=Number(a[1]),u=new Float32Array(c**3*4),d=new o.Pa4(0,0,0),g=new o.Pa4(1,1,1);if(a=/DOMAIN_MIN +([\d.]+) +([\d.]+) +([\d.]+)/.exec(e),null!==a&&d.set(Number(a[1]),Number(a[2]),Number(a[3])),a=/DOMAIN_MAX +([\d.]+) +([\d.]+) +([\d.]+)/.exec(e),null!==a&&g.set(Number(a[1]),Number(a[2]),Number(a[3])),d.x>g.x||d.y>g.y||d.z>g.z)throw d.set(0,0,0),g.set(1,1,1),new Error("Invalid input domain");let p=0;for(;null!==(a=s.exec(e));)u[p++]=Number(a[1]),u[p++]=Number(a[2]),u[p++]=Number(a[3]),u[p++]=1;const v=new Me(u,c);return v.domainMin.copy(d),v.domainMax.copy(g),null!==l&&(v.name=l),v}}},4306:(Et,Re,z)=>{z.d(Re,{$j:()=>re,F3:()=>Ce,Rn:()=>oe,SE:()=>we,iv:()=>Ne});var o=z(3152),B=z(5352),P=z(9796),Y=z(8405),xe=z(3494);const ve=["*"];let re=(()=>{class A extends B.ZM{get effectType(){return Y.rk}set luminanceThreshold(f){this.set({luminanceThreshold:(0,o.su)(f)})}set luminanceSmoothing(f){this.set({luminanceSmoothing:(0,o.su)(f)})}set intensity(f){this.set({intensity:(0,o.su)(f)})}set resolutionScale(f){this.set({resolutionScale:(0,o.su)(f)})}set resolutionX(f){this.set({resolutionX:(0,o.su)(f)})}set resolutionY(f){this.set({resolutionY:(0,o.su)(f)})}set width(f){this.set({width:(0,o.su)(f)})}set height(f){this.set({height:(0,o.su)(f)})}set kernelSize(f){this.set({kernelSize:f})}get defaultBlendMode(){return Y.YQ.SCREEN}get effectOptionsFields(){return{...super.effectOptionsFields,luminanceThreshold:!0,luminanceSmoothing:!0,intensity:!0,resolutionScale:!0,resolutionX:!0,resolutionY:!0,width:!0,height:!0,kernelSize:!0}}}return A.\u0275fac=function(){let m;return function(D){return(m||(m=P.n5z(A)))(D||A)}}(),A.\u0275cmp=P.Xpm({type:A,selectors:[["ngt-bloom-effect"]],inputs:{luminanceThreshold:"luminanceThreshold",luminanceSmoothing:"luminanceSmoothing",intensity:"intensity",resolutionScale:"resolutionScale",resolutionX:"resolutionX",resolutionY:"resolutionY",width:"width",height:"height",kernelSize:"kernelSize"},standalone:!0,features:[P._Bn([(0,B.lT)(A),(0,B.hs)(A)]),P.qOj,P.jDz],ngContentSelectors:ve,decls:1,vars:0,template:function(f,D){1&f&&(P.F$t(),P.Hsn(0))},encapsulation:2,changeDetection:0}),A})(),oe=(()=>{class A{}return A.\u0275fac=function(f){return new(f||A)},A.\u0275mod=P.oAB({type:A}),A.\u0275inj=P.cJS({imports:[re]}),A})(),we=(()=>{class A extends B.ZM{set distanceScaling(f){this.set({distanceScaling:(0,o.Ig)(f)})}set depthAwareUpsampling(f){this.set({depthAwareUpsampling:(0,o.Ig)(f)})}set normalDepthBuffer(f){this.set({normalDepthBuffer:f})}set samples(f){this.set({samples:(0,o.su)(f)})}set rings(f){this.set({rings:(0,o.su)(f)})}set worldDistanceThreshold(f){this.set({worldDistanceThreshold:(0,o.su)(f)})}set worldDistanceFalloff(f){this.set({worldDistanceFalloff:(0,o.su)(f)})}set worldProximityThreshold(f){this.set({worldProximityThreshold:(0,o.su)(f)})}set worldProximityFalloff(f){this.set({worldProximityFalloff:(0,o.su)(f)})}set distanceThreshold(f){this.set({distanceThreshold:(0,o.su)(f)})}set distanceFalloff(f){this.set({distanceFalloff:(0,o.su)(f)})}set rangeThreshold(f){this.set({rangeThreshold:(0,o.su)(f)})}set rangeFalloff(f){this.set({rangeFalloff:(0,o.su)(f)})}set minRadiusScale(f){this.set({minRadiusScale:(0,o.su)(f)})}set luminanceInfluence(f){this.set({luminanceInfluence:(0,o.su)(f)})}set radius(f){this.set({radius:(0,o.su)(f)})}set intensity(f){this.set({intensity:(0,o.su)(f)})}set bias(f){this.set({bias:(0,o.su)(f)})}set fade(f){this.set({fade:(0,o.su)(f)})}set color(f){this.set({color:f})}set width(f){this.set({width:(0,o.su)(f)})}set height(f){this.set({height:(0,o.su)(f)})}get effectType(){return Y.bn}get skipConfigureBlendMode(){return!0}get effectOptionsFields(){return{...super.effectOptionsFields,distanceScaling:!0,depthAwareUpsampling:!0,normalDepthBuffer:!0,samples:!0,rings:!0,worldDistanceThreshold:!0,worldDistanceFalloff:!0,worldProximityThreshold:!0,worldProximityFalloff:!0,distanceThreshold:!0,distanceFalloff:!0,rangeThreshold:!0,rangeFalloff:!0,minRadiusScale:!0,luminanceInfluence:!0,radius:!0,intensity:!0,bias:!0,fade:!0,color:!0,width:!0,height:!0}}adjustCtorParams(f){const{camera:D,normalPass:ee,depthDownSamplingPass:ae,resolutionScale:Ae}=this.effectComposer.get();if(null===ee&&null===ae)throw new Error("SSAO can only be used when normalPass is enabled");const{samples:je,rings:Ke,distanceThreshold:Ze,distanceFalloff:Ge,rangeThreshold:Je,rangeFalloff:qe,luminanceInfluence:$e,radius:et,scale:tt,bias:nt,intensity:it,color:rt,normalDepthBuffer:st,depthAwareUpsampling:at,...ot}=f[0];return[D,ee&&!ae?ee.texture:null,{samples:je??30,rings:Ke??4,distanceThreshold:Ze??1,distanceFalloff:Ge??0,rangeThreshold:Je??.5,rangeFalloff:qe??.1,luminanceInfluence:$e??.9,radius:et??20,scale:tt??.5,bias:nt??.5,intensity:it??1,color:rt??null,normalDepthBuffer:st??(ae?ae.texture:null),resolutionScale:Ae??1,depthAwareUpsampling:at??!0,...ot}]}get ctorParams$(){return this.select(this.effectComposer.select(f=>f.camera),this.effectComposer.select(f=>f.normalPass))}}return A.\u0275fac=function(){let m;return function(D){return(m||(m=P.n5z(A)))(D||A)}}(),A.\u0275cmp=P.Xpm({type:A,selectors:[["ngt-ssao-effect"]],inputs:{distanceScaling:"distanceScaling",depthAwareUpsampling:"depthAwareUpsampling",normalDepthBuffer:"normalDepthBuffer",samples:"samples",rings:"rings",worldDistanceThreshold:"worldDistanceThreshold",worldDistanceFalloff:"worldDistanceFalloff",worldProximityThreshold:"worldProximityThreshold",worldProximityFalloff:"worldProximityFalloff",distanceThreshold:"distanceThreshold",distanceFalloff:"distanceFalloff",rangeThreshold:"rangeThreshold",rangeFalloff:"rangeFalloff",minRadiusScale:"minRadiusScale",luminanceInfluence:"luminanceInfluence",radius:"radius",intensity:"intensity",bias:"bias",fade:"fade",color:"color",width:"width",height:"height"},standalone:!0,features:[P._Bn([(0,B.lT)(A),(0,B.hs)(A)]),P.qOj,P.jDz],ngContentSelectors:ve,decls:1,vars:0,template:function(f,D){1&f&&(P.F$t(),P.Hsn(0))},encapsulation:2,changeDetection:0}),A})(),Ne=(()=>{class A{}return A.\u0275fac=function(f){return new(f||A)},A.\u0275mod=P.oAB({type:A}),A.\u0275inj=P.cJS({imports:[we]}),A})(),Ce=(()=>{class A extends B.ZM{constructor(){super(...arguments),this.setLut=this.effect((0,xe.b)(()=>{const f=this.store.get(ae=>ae.invalidate),{lut:D,tetrahedralInterpolation:ee}=this.get();D&&(this.instanceValue.lut=D),ee&&(this.instanceValue.tetrahedralInterpolation=ee),f()}))}set lut(f){this.set({lut:f})}set tetrahedralInterpolation(f){this.set({tetrahedralInterpolation:(0,o.Ig)(f)})}get effectType(){return Y.CI}get skipConfigureBlendMode(){return!0}get effectOptionsFields(){return{...super.effectOptionsFields,lut:!1,tetrahedralInterpolation:!0}}adjustCtorParams(f){const{lut:D,...ee}=f[0];return[D,ee]}postInit(){super.postInit(),this.setLut(this.select(this.instance$,this.select(f=>f.lut),this.select(f=>f.tetrahedralInterpolation).pipe((0,o.Xb)())))}}return A.\u0275fac=function(){let m;return function(D){return(m||(m=P.n5z(A)))(D||A)}}(),A.\u0275cmp=P.Xpm({type:A,selectors:[["ngt-lut-effect"]],inputs:{lut:"lut",tetrahedralInterpolation:"tetrahedralInterpolation"},standalone:!0,features:[P._Bn([(0,B.lT)(A),(0,B.hs)(A)]),P.qOj,P.jDz],ngContentSelectors:ve,decls:1,vars:0,template:function(f,D){1&f&&(P.F$t(),P.Hsn(0))},encapsulation:2,changeDetection:0}),A})()},5352:(Et,Re,z)=>{z.d(Re,{ZM:()=>y,dM:()=>te,hs:()=>Fe,km:()=>le,lT:()=>ce,sY:()=>E});var o=z(3152),B=z(9796),P=z(8405),Y=z(3494),xe=z(8721),ve=z(5159),re=z(2657),oe=z(4372),ne=z(610),ie=z(6128);const He=function(M,V){return{group:M,effectComposer:V}};function ke(M,V){if(1&M&&B.GkF(0,2),2&M){const h=B.oxw();B.Q6J("ngTemplateOutlet",h.content.templateRef)("ngTemplateOutletContext",B.WLB(2,He,h.groupRef,h.instance))}}let E=(()=>{class M{constructor(h){this.templateRef=h}static ngTemplateContextGuard(h,w){return!0}}return M.\u0275fac=function(h){return new(h||M)(B.Y36(B.Rgc))},M.\u0275dir=B.lG2({type:M,selectors:[["ng-template","ngt-effect-composer-content",""]],standalone:!0}),M})(),te=(()=>{class M extends o.WZ{constructor(){super(...arguments),this.composerInitParams$=this.select(this.store.select(h=>h.gl),this.select(h=>h.camera),this.select(h=>h.scene),this.select(h=>h.depthBuffer).pipe((0,o.Xb)()),this.select(h=>h.stencilBuffer).pipe((0,o.Xb)()),this.select(h=>h.multisampling),this.select(h=>h.frameBufferType),this.select(h=>h.disableNormalPass).pipe((0,o.Xb)()),this.select(h=>h.resolutionScale).pipe((0,o.Xb)())),this.sizeParams$=this.select(this.instance$,this.store.select(h=>h.size)),this.beforeRenderParams$=this.select(this.instance$,this.select(h=>h.autoClear),this.select(h=>h.enabled),this.select(h=>h.renderPriority)),this.isWebGLAvailable=(0,o.rz)(),this.init=this.effect((0,Y.b)(()=>{const{gl:h,scene:w,camera:L}=this.store.get(),{scene:O,camera:W,depthBuffer:j,stencilBuffer:ue,multisampling:se,frameBufferType:we,disableNormalPass:Ne,resolutionScale:Ce}=this.get(),fe=O||w,A=W||L;if(h&&fe&&A){const m=this.prepareInstance(new P.xC(h,{depthBuffer:j,stencilBuffer:ue,multisampling:se>0&&this.isWebGLAvailable?se:0,frameBufferType:we}));m.addPass(new P.CD(fe,A));let f=null,D=null;Ne||(D=new P.gh(fe,A),D.enabled=!1,m.addPass(D),void 0!==Ce&&this.isWebGLAvailable&&(f=new P.xs({normalBuffer:D.texture,resolutionScale:Ce}),f.enabled=!1,m.addPass(f))),this.set({depthDownSamplingPass:f,normalPass:D})}})),this.setSize=this.effect((0,Y.b)(()=>{const h=this.get(w=>w.instance);if(h.value){const w=this.store.get(L=>L.size);h.value.setSize(w.width,w.height)}})),this.setBeforeRender=this.effect((0,o.oe)(()=>{const{renderPriority:h,enabled:w,instance:L,autoClear:O}=this.get(),W=this.store.get(j=>j.gl);return this.store.registerBeforeRender({callback:({delta:j})=>{w&&(W.autoClear=O,L.value.render(j))},priority:w?h:0})})),this.effectPasses=this.effect((0,o.oe)(()=>{let h;const w=this.store.get(se=>se.camera),{instance:L,camera:O,normalPass:W,depthDownSamplingPass:j,groupRef:ue}=this.get();return L.value&&ue.value&&ue.value.__ngt__.objects.value.length&&(h=new P.H5(O||w,...ue.value.__ngt__.objects.value.map(se=>se.value)),h.renderToScreen=!0,L.value.addPass(h),W&&(W.enabled=!0),j&&(j.enabled=!0)),()=>{h&&L.value?.removePass(h),W&&(W.enabled=!1),j&&(j.enabled=!1)}}))}set enabled(h){this.set({enabled:(0,o.Ig)(h)})}set depthBuffer(h){this.set({depthBuffer:(0,o.Ig)(h)})}set disableNormalPass(h){this.set({disableNormalPass:(0,o.Ig)(h)})}set stencilBuffer(h){this.set({stencilBuffer:(0,o.Ig)(h)})}set autoClear(h){this.set({autoClear:(0,o.Ig)(h)})}set resolutionScale(h){this.set({resolutionScale:(0,o.su)(h)})}set multisampling(h){this.set({multisampling:(0,o.su)(h)})}set frameBufferType(h){this.set({frameBufferType:h})}set renderPriority(h){this.set({renderPriority:(0,o.su)(h)})}set camera(h){this.set({camera:h})}set scene(h){this.set({scene:h})}get groupRef(){return this.get(h=>h.groupRef)}preInit(){super.preInit(),this.set(h=>({groupRef:new o.Rl,enabled:h.enabled??!0,renderPriority:h.renderPriority??1,autoClear:h.autoClear??!0,multisampling:h.multisampling??8,camera:h.camera??this.store.get(w=>w.camera),scene:h.scene??this.store.get(w=>w.scene),frameBufferType:h.frameBufferType??ie.cLu}))}ngAfterViewInit(){this.zone.runOutsideAngular(()=>{this.store.onReady(()=>{const h=this.select(this.select(w=>w.camera),this.select(w=>w.normalPass),this.select(w=>w.depthDownSamplingPass),this.instance$,this.groupRef.pipe((0,xe.h)(w=>!!w)),this.groupRef.pipe((0,xe.h)(w=>!!w),(0,ve.w)(w=>w.__ngt__.objects),(0,re.O)([])));this.init(this.composerInitParams$),this.setSize(this.sizeParams$),this.setBeforeRender(this.beforeRenderParams$),this.effectPasses(h)})})}}return M.\u0275fac=function(){let V;return function(w){return(V||(V=B.n5z(M)))(w||M)}}(),M.\u0275cmp=B.Xpm({type:M,selectors:[["ngt-effect-composer"]],contentQueries:function(h,w,L){if(1&h&&B.Suo(L,E,5),2&h){let O;B.iGM(O=B.CRH())&&(w.content=O.first)}},inputs:{enabled:"enabled",depthBuffer:"depthBuffer",disableNormalPass:"disableNormalPass",stencilBuffer:"stencilBuffer",autoClear:"autoClear",resolutionScale:"resolutionScale",multisampling:"multisampling",frameBufferType:"frameBufferType",renderPriority:"renderPriority",camera:"camera",scene:"scene"},standalone:!0,features:[B._Bn([(0,o.RD)(M),(0,o.wY)(M,V=>V.groupRef),(0,o.Hm)(M)]),B.qOj,B.jDz],decls:2,vars:2,consts:[[3,"ref"],[3,"ngTemplateOutlet","ngTemplateOutletContext",4,"ngIf"],[3,"ngTemplateOutlet","ngTemplateOutletContext"]],template:function(h,w){1&h&&(B.TgZ(0,"ngt-group",0),B.YNc(1,ke,1,5,"ng-container",1),B.qZA()),2&h&&(B.Q6J("ref",w.groupRef),B.xp6(1),B.Q6J("ngIf",w.content))},dependencies:[oe.U,ne.O5,ne.tP],encapsulation:2,changeDetection:0}),M})(),le=(()=>{class M{}return M.\u0275fac=function(h){return new(h||M)},M.\u0275mod=B.oAB({type:M}),M.\u0275inj=B.cJS({imports:[te]}),M})();const[me,Fe,_]=(0,o.hJ)("NgtCommonEffect ref",o.UV);let y=(()=>{class M extends o.WZ{constructor(){if(super(),this.effectOptions$=this.select(this.select(h=>h.opacity).pipe((0,o.Xb)()),this.select(h=>h.blendFunction),this.instance$),this.effectComposer=(0,B.f3M)(te,{optional:!0}),this.configureBlendMode=this.effect((0,Y.b)(()=>{const{instance:h,blendFunction:w,opacity:L}=this.get(),O=this.store.get(W=>W.invalidate);h.value&&(h.value.blendMode.blendFunction=w||0===w?w:this.defaultBlendMode,void 0!==L&&(h.value.blendMode.opacity.value=L)),O()})),this.init=this.effect((0,o.oe)(h=>{const w=this.adjustCtorParams([h]),L=this.prepareInstance(new this.effectType(...w));return()=>{const O=L.__ngt__.parent?.value;O&&O.isGroup&&O.__ngt__.objects.set(W=>W.filter(j=>j.value!==L)),L.dispose()}})),!this.effectComposer)throw new Error("Effects can only be used within <ngt-effect-composer>")}set opacity(h){this.set({opacity:(0,o.su)(h)})}set blendFunction(h){this.set({blendFunction:h})}get defaultBlendMode(){return P.YQ.NORMAL}preInit(){this.set(h=>({blendFunction:h.blendFunction||this.defaultBlendMode}))}get effectOptionsFields(){return{blendFunction:!1}}ngOnInit(){super.ngOnInit(),this.zone.runOutsideAngular(()=>{this.store.onReady(()=>{this.init(this.select((0,o.ig)(this,this.effectOptionsFields,!0),this.ctorParams$,h=>h)),this.skipConfigureBlendMode||this.configureBlendMode(this.select(this.select(h=>h.opacity).pipe((0,o.Xb)()),this.select(h=>h.blendMode),this.instance$)),this.postInit()})})}get skipConfigureBlendMode(){return!1}}return M.\u0275fac=function(h){return new(h||M)},M.\u0275dir=B.lG2({type:M,inputs:{opacity:"opacity",blendFunction:"blendFunction"},features:[B.qOj]}),M})();const ce=(0,o.aM)(y,o.Nx)}}]);